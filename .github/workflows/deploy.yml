name: ğŸš€ Despliegue AutomÃ¡tico del Curso

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:

env:
  COURSE_NAME: "Curso de AdministraciÃ³n de Windows desde la Consola"
  VERSION: "2.0.0"

jobs:
  # ğŸ“¦ Preparar Release
  prepare-release:
    name: ğŸ“¦ Preparar Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ·ï¸ Obtener versiÃ³n
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=$(date +'%Y.%m.%d')
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ VersiÃ³n: $VERSION"
        
    - name: ğŸ“Š Generar changelog
      run: |
        echo "# ğŸ“‹ Changelog - VersiÃ³n ${{ steps.get_version.outputs.version }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## ğŸ‰ Nuevas CaracterÃ­sticas" >> CHANGELOG.md
        echo "- ImplementaciÃ³n de GitHub Actions para CI/CD" >> CHANGELOG.md
        echo "- ValidaciÃ³n automÃ¡tica de scripts batch" >> CHANGELOG.md
        echo "- GeneraciÃ³n automÃ¡tica de documentaciÃ³n" >> CHANGELOG.md
        echo "- Pruebas automÃ¡ticas del sistema" >> CHANGELOG.md
        echo "- AnÃ¡lisis de calidad automatizado" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## ğŸ”§ Mejoras" >> CHANGELOG.md
        echo "- Estructura de directorios optimizada" >> CHANGELOG.md
        echo "- DocumentaciÃ³n mejorada" >> CHANGELOG.md
        echo "- Scripts con validaciÃ³n de privilegios" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## ğŸ› Correcciones" >> CHANGELOG.md
        echo "- CorrecciÃ³n de errores de sintaxis en scripts" >> CHANGELOG.md
        echo "- Mejora en la validaciÃ³n de archivos" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## ğŸ“… Fecha de Release" >> CHANGELOG.md
        echo "- **Fecha:** $(date)" >> CHANGELOG.md
        echo "- **Commit:** $GITHUB_SHA" >> CHANGELOG.md
        
    - name: ğŸ“¤ Subir changelog
      uses: actions/upload-artifact@v3
      with:
        name: changelog-${{ steps.get_version.outputs.version }}
        path: CHANGELOG.md
        retention-days: 30

  # ğŸ“¦ Crear Release
  create-release:
    name: ğŸ“¦ Crear Release
    runs-on: ubuntu-latest
    needs: prepare-release
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Descargar artifacts
      uses: actions/download-artifact@v3
      with:
        name: changelog-${{ steps.get_version.outputs.version }}
        path: ./
        
    - name: ğŸ·ï¸ Crear release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: false 