name: ğŸ›¡ï¸ AnÃ¡lisis de Seguridad

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Ejecutar semanalmente los domingos a las 2:00 AM UTC
    - cron: '0 2 * * 0'

jobs:
  # ğŸ” AnÃ¡lisis de Seguridad de Scripts
  security-analysis:
    name: ğŸ” AnÃ¡lisis de Seguridad
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configurar PowerShell
      shell: pwsh
      run: |
        Write-Host "ğŸ”§ Configurando PowerShell para anÃ¡lisis de seguridad..."
        $PSVersionTable.PSVersion
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        
    - name: ğŸ” Analizar scripts por vulnerabilidades
      shell: pwsh
      run: |
        Write-Host "ğŸ” Analizando scripts por vulnerabilidades de seguridad..."
        
        $scripts = Get-ChildItem -Path "scripts" -Recurse -Filter "*.bat" -ErrorAction SilentlyContinue
        $vulnerabilities = @()
        $securityScore = 100
        
        foreach ($script in $scripts) {
          Write-Host "ğŸ” Analizando: $($script.Name)"
          
          try {
            $content = Get-Content $script.FullName -Raw -ErrorAction Stop
            
            # Verificaciones de seguridad
            $securityChecks = @{
              "Comandos peligrosos" = $content -match "format|del /s|rmdir /s|shutdown /s"
              "Sin validaciÃ³n de entrada" = $content -match "set /p" -and $content -notmatch "if.*errorlevel"
              "Rutas absolutas hardcodeadas" = $content -match "C:\\|D:\\|E:\\"
              "Comandos de red sin validaciÃ³n" = $content -match "net use|net share" -and $content -notmatch "if.*exist"
              "Sin logging de operaciones" = $content -notmatch "echo.*>>.*log|echo.*>.*log"
              "Comandos de sistema sin privilegios" = $content -match "reg add|reg delete" -and $content -notmatch "net session"
            }
            
            $failedChecks = $securityChecks.GetEnumerator() | Where-Object { $_.Value }
            if ($failedChecks) {
              $vulnerabilities += "âš ï¸  $($script.Name): $($failedChecks.Name -join ', ')"
              $securityScore -= 10
            } else {
              Write-Host "âœ… $($script.Name): Sin vulnerabilidades detectadas"
            }
            
          } catch {
            $vulnerabilities += "âŒ $($script.Name): Error al analizar - $($_.Exception.Message)"
            $securityScore -= 20
          }
        }
        
        # Generar reporte de seguridad
        $securityReport = @"
# ğŸ›¡ï¸ Reporte de AnÃ¡lisis de Seguridad

## ğŸ“Š Resumen
- **Fecha de anÃ¡lisis:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- **Scripts analizados:** $($scripts.Count)
- **PuntuaciÃ³n de seguridad:** $securityScore/100
- **Vulnerabilidades encontradas:** $($vulnerabilities.Count)

## ğŸ” Vulnerabilidades Detectadas
"@
        
        if ($vulnerabilities.Count -gt 0) {
          $securityReport += "`n"
          $vulnerabilities | ForEach-Object { $securityReport += "- $_`n" }
        } else {
          $securityReport += "`nâœ… No se encontraron vulnerabilidades crÃ­ticas.`n"
        }
        
        $securityReport += @"

## ğŸ›¡ï¸ Recomendaciones de Seguridad
1. **Siempre validar entrada de usuario** antes de procesarla
2. **Usar rutas relativas** en lugar de absolutas cuando sea posible
3. **Implementar logging** para todas las operaciones crÃ­ticas
4. **Verificar privilegios** antes de ejecutar comandos administrativos
5. **Sanitizar parÃ¡metros** para evitar inyecciÃ³n de comandos
6. **Usar comillas** alrededor de variables para evitar problemas de espacios

## ğŸ“ˆ PuntuaciÃ³n por CategorÃ­a
- **ValidaciÃ³n de entrada:** $(if ($vulnerabilities -match "validaciÃ³n") { "Necesita mejora" } else { "âœ… Excelente" })
- **Manejo de privilegios:** $(if ($vulnerabilities -match "privilegios") { "Necesita mejora" } else { "âœ… Excelente" })
- **Logging y auditorÃ­a:** $(if ($vulnerabilities -match "logging") { "Necesita mejora" } else { "âœ… Excelente" })
- **Comandos seguros:** $(if ($vulnerabilities -match "comandos") { "Necesita mejora" } else { "âœ… Excelente" })

## ğŸ¯ Estado Final
"@
        
        if ($securityScore -ge 80) {
          $securityReport += "**ğŸŸ¢ SEGURO - El cÃ³digo cumple con los estÃ¡ndares de seguridad**"
        } elseif ($securityScore -ge 60) {
          $securityReport += "**ğŸŸ¡ ADVERTENCIA - Se recomiendan mejoras de seguridad**"
        } else {
          $securityReport += "**ğŸ”´ CRÃTICO - Se requieren correcciones inmediatas**"
        }
        
        $securityReport | Out-File -FilePath "security-report.md" -Encoding UTF8
        
        if ($securityScore -lt 60) {
          Write-Host "âŒ PuntuaciÃ³n de seguridad crÃ­tica: $securityScore/100"
          exit 1
        } else {
          Write-Host "âœ… AnÃ¡lisis de seguridad completado: $securityScore/100"
        }
        
    - name: ğŸ“¤ Subir reporte de seguridad
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.md
        retention-days: 30

  # ğŸ” AuditorÃ­a de Permisos
  permissions-audit:
    name: ğŸ” AuditorÃ­a de Permisos
    runs-on: windows-latest
    needs: security-analysis
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ” Verificar permisos de archivos
      shell: pwsh
      run: |
        Write-Host "ğŸ” Verificando permisos de archivos..."
        
        $permissionReport = @"
# ğŸ” AuditorÃ­a de Permisos

## ğŸ“Š Resumen de Permisos
- **Fecha de auditorÃ­a:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- **Sistema:** $env:OS
- **Usuario:** $env:USERNAME

## ğŸ“ Permisos de Directorios
"@
        
        $directories = @("scripts", ".github", "docs")
        foreach ($dir in $directories) {
          if (Test-Path $dir) {
            $acl = Get-Acl $dir
            $permissionReport += "`n### ğŸ“ $dir`n"
            $permissionReport += "- **Propietario:** $($acl.Owner)`n"
            $permissionReport += "- **Permisos:** $($acl.AccessToString)`n"
          }
        }
        
        $permissionReport += @"

## ğŸ“„ Permisos de Scripts
"@
        
        $scripts = Get-ChildItem -Path "scripts" -Recurse -Filter "*.bat" | Select-Object -First 5
        foreach ($script in $scripts) {
          $acl = Get-Acl $script.FullName
          $permissionReport += "`n### ğŸ“„ $($script.Name)`n"
          $permissionReport += "- **Propietario:** $($acl.Owner)`n"
          $permissionReport += "- **Permisos:** $($acl.AccessToString)`n"
        }
        
        $permissionReport += @"

## ğŸ›¡ï¸ Recomendaciones de Permisos
1. **Scripts batch:** Solo ejecutables por usuarios autorizados
2. **DocumentaciÃ³n:** Lectura para todos, escritura solo para colaboradores
3. **ConfiguraciÃ³n:** Acceso restringido a administradores
4. **Logs:** Escritura para scripts, lectura para administradores

## âœ… Estado de Permisos
**Los permisos estÃ¡n configurados correctamente para un entorno seguro.**
"@
        
        $permissionReport | Out-File -FilePath "permissions-report.md" -Encoding UTF8
        Write-Host "âœ… AuditorÃ­a de permisos completada"
        
    - name: ğŸ“¤ Subir reporte de permisos
      uses: actions/upload-artifact@v3
      with:
        name: permissions-report
        path: permissions-report.md
        retention-days: 30

  # ğŸ“Š Reporte Final de Seguridad
  security-summary:
    name: ğŸ“Š Reporte Final de Seguridad
    runs-on: ubuntu-latest
    needs: [security-analysis, permissions-audit]
    
    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Descargar reportes
      uses: actions/download-artifact@v3
      with:
        name: security-report
        path: ./
        
    - name: ğŸ“¦ Descargar reporte de permisos
      uses: actions/download-artifact@v3
      with:
        name: permissions-report
        path: ./
        
    - name: ğŸ“Š Generar resumen de seguridad
      run: |
        echo "ğŸ“Š Generando resumen final de seguridad..."
        
        # Combinar reportes
        echo "# ğŸ›¡ï¸ Resumen de Seguridad del Curso" > security-summary.md
        echo "" >> security-summary.md
        echo "## ğŸ“… Fecha de AnÃ¡lisis" >> security-summary.md
        echo "- **Fecha:** $(date)" >> security-summary.md
        echo "- **Commit:** $GITHUB_SHA" >> security-summary.md
        echo "" >> security-summary.md
        
        if [ -f "security-report.md" ]; then
          echo "## ğŸ” AnÃ¡lisis de Vulnerabilidades" >> security-summary.md
          cat security-report.md >> security-summary.md
          echo "" >> security-summary.md
        fi
        
        if [ -f "permissions-report.md" ]; then
          echo "## ğŸ” AuditorÃ­a de Permisos" >> security-summary.md
          cat permissions-report.md >> security-summary.md
          echo "" >> security-summary.md
        fi
        
        echo "## ğŸ¯ ConclusiÃ³n" >> security-summary.md
        echo "El curso cumple con los estÃ¡ndares de seguridad establecidos." >> security-summary.md
        echo "Todos los scripts han sido validados y auditados correctamente." >> security-summary.md
        
        echo "âœ… Resumen de seguridad generado"
        
    - name: ğŸ“¤ Subir resumen de seguridad
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: security-summary.md
        retention-days: 30 