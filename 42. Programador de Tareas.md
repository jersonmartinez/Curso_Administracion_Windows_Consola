# 42. Programador de Tareas ⏰🤖

> *"La automatización es el futuro de la administración de sistemas. Con el Programador de Tareas, puedes hacer que Windows trabaje para ti mientras duermes, ejecutando tareas críticas en el momento perfecto."*

## Introducción

¿Te imaginas tener un asistente personal que ejecute todas tus tareas repetitivas automáticamente? ¿O un sistema que mantenga tu infraestructura funcionando perfectamente sin intervención humana? El **Programador de Tareas** de Windows es exactamente eso: tu robot personal que nunca duerme y siempre está listo para trabajar.

En este capítulo, descubrirás cómo convertir tu sistema Windows en una máquina autónoma e inteligente, capaz de ejecutar backups automáticos, limpiezas programadas, monitoreos continuos y mucho más. La automatización no es solo una conveniencia; es una necesidad en el mundo moderno de la administración de sistemas.

## Conceptos Clave

### ⏰ **Tarea Programada**
Un trabajo o script que se ejecuta automáticamente en momentos específicos o bajo condiciones determinadas.

### 🔄 **Trigger (Disparador)**
Evento o condición que activa la ejecución de una tarea programada (tiempo, inicio del sistema, evento del sistema, etc.).

### 🎯 **Action (Acción)**
Comando, script o programa que se ejecuta cuando se activa la tarea.

### 📋 **Condition (Condición)**
Criterios adicionales que deben cumplirse para que la tarea se ejecute (conectividad de red, estado del sistema, etc.).

## Comandos Principales

### `SCHTASKS` - Gestión de tareas programadas
```batch
schtasks [opciones]
```

**Opciones principales:**
- `/create` - Crear nueva tarea
- `/delete` - Eliminar tarea existente
- `/query` - Listar tareas
- `/change` - Modificar tarea existente
- `/run` - Ejecutar tarea inmediatamente
- `/end` - Detener tarea en ejecución

### `SCHTASKS /CREATE` - Crear tarea
```batch
schtasks /create /tn "NombreTarea" /tr "Comando" /sc [diario|semanal|mensual|inicio] /st "HH:MM"
```

### `SCHTASKS /QUERY` - Listar tareas
```batch
schtasks /query [/fo table|list|csv] [/v]
```

### `SCHTASKS /RUN` - Ejecutar tarea
```batch
schtasks /run /tn "NombreTarea"
```

## Ejemplos Prácticos

### 1. **Crear tarea diaria de backup**
```batch
schtasks /create /tn "Backup_Diario" /tr "C:\scripts\backup.bat" /sc daily /st "02:00"
```
**Propósito:** Automatizar backups diarios a las 2:00 AM cuando el sistema tiene menos carga. Esencial para proteger datos críticos sin intervención manual.

### 2. **Tarea semanal de limpieza del sistema**
```batch
schtasks /create /tn "Limpieza_Semanal" /tr "cleanmgr.exe /sagerun:1" /sc weekly /d MON /st "03:00"
```
**Propósito:** Mantener el sistema optimizado ejecutando limpieza automática cada lunes a las 3:00 AM. Previene la acumulación de archivos temporales.

### 3. **Tarea que se ejecuta al iniciar el sistema**
```batch
schtasks /create /tn "Inicio_Servicios" /tr "C:\scripts\iniciar_servicios.bat" /sc onstart
```
**Propósito:** Asegurar que servicios críticos estén funcionando cada vez que el sistema se reinicia. Ideal para servidores que deben estar siempre disponibles.

### 4. **Tarea con usuario específico**
```batch
schtasks /create /tn "Reporte_Mensual" /tr "C:\scripts\generar_reporte.bat" /sc monthly /d 1 /st "09:00" /ru "DOMINIO\usuario" /rp "contraseña"
```
**Propósito:** Ejecutar tareas que requieren permisos específicos o credenciales de dominio. Útil para reportes corporativos que necesitan acceso a recursos de red.

### 5. **Tarea con múltiples triggers**
```batch
schtasks /create /tn "Monitoreo_Inteligente" /tr "C:\scripts\monitor.bat" /sc onlogon /mo 30
```
**Propósito:** Monitorear el sistema cada 30 minutos después del inicio de sesión. Perfecto para detectar problemas de rendimiento en tiempo real.

### 6. **Listar todas las tareas del sistema**
```batch
schtasks /query /fo table /v
```
**Propósito:** Obtener una vista completa de todas las tareas programadas con detalles de configuración. Esencial para auditorías de seguridad y mantenimiento.

### 7. **Ejecutar tarea inmediatamente**
```batch
schtasks /run /tn "Backup_Diario"
```
**Propósito:** Forzar la ejecución de una tarea sin esperar su horario programado. Útil para pruebas o situaciones de emergencia.

### 8. **Tarea con condición de red**
```batch
schtasks /create /tn "Sync_Red" /tr "C:\scripts\sincronizar.bat" /sc daily /st "06:00" /it
```
**Propósito:** Sincronizar datos solo cuando hay conectividad de red. El parámetro `/it` requiere que el usuario esté conectado.

### 9. **Tarea con prioridad alta**
```batch
schtasks /create /tn "Tarea_Critica" /tr "C:\scripts\tarea_critica.bat" /sc daily /st "00:00" /rl highest
```
**Propósito:** Ejecutar tareas críticas con máxima prioridad del sistema. Ideal para procesos que no pueden esperar.

### 10. **Tarea con reintentos automáticos**
```batch
schtasks /create /tn "Tarea_Resiliente" /tr "C:\scripts\tarea_resiliente.bat" /sc daily /st "04:00" /z
```
**Propósito:** Crear tareas que se eliminan automáticamente después de completarse. Útil para tareas únicas o de limpieza.

## Scripts Avanzados

### Script para Gestión Avanzada de Tareas Programadas

```batch
@echo off
setlocal enabledelayedexpansion
title Gestión Avanzada de Tareas Programadas
color 0E

echo.
echo ========================================
echo    GESTIÓN AVANZADA DE TAREAS PROGRAMADAS
echo ========================================
echo.

:menu_principal
echo [1] Crear nueva tarea
echo [2] Listar tareas existentes
echo [3] Ejecutar tarea
echo [4] Eliminar tarea
echo [5] Modificar tarea
echo [6] Crear tarea de backup automático
echo [7] Crear tarea de limpieza
echo [8] Crear tarea de monitoreo
echo [9] Exportar configuración
echo [10] Salir
echo.
set /p opcion="Selecciona una opción: "

if "%opcion%"=="1" goto crear_tarea
if "%opcion%"=="2" goto listar_tareas
if "%opcion%"=="3" goto ejecutar_tarea
if "%opcion%"=="4" goto eliminar_tarea
if "%opcion%"=="5" goto modificar_tarea
if "%opcion%"=="6" goto tarea_backup
if "%opcion%"=="7" goto tarea_limpieza
if "%opcion%"=="8" goto tarea_monitoreo
if "%opcion%"=="9" goto exportar_config
if "%opcion%"=="10" goto salir
goto menu_principal

:crear_tarea
echo.
set /p nombre="Nombre de la tarea: "
set /p comando="Comando a ejecutar: "
set /p frecuencia="Frecuencia (daily/weekly/monthly/onstart): "
set /p hora="Hora (HH:MM): "
set /p usuario="Usuario (opcional): "

if "%usuario%"=="" (
    schtasks /create /tn "%nombre%" /tr "%comando%" /sc %frecuencia% /st %hora%
) else (
    set /p contraseña="Contraseña: "
    schtasks /create /tn "%nombre%" /tr "%comando%" /sc %frecuencia% /st %hora% /ru "%usuario%" /rp "%contraseña%"
)

echo Tarea creada exitosamente.
pause
goto menu_principal

:listar_tareas
echo.
echo Tareas programadas en el sistema:
echo ----------------------------------------
schtasks /query /fo table
echo.
pause
goto menu_principal

:ejecutar_tarea
echo.
set /p nombre="Nombre de la tarea: "
echo.
echo Ejecutando tarea %nombre%...
schtasks /run /tn "%nombre%"
echo Tarea ejecutada.
pause
goto menu_principal

:eliminar_tarea
echo.
set /p nombre="Nombre de la tarea a eliminar: "
echo.
echo Eliminando tarea %nombre%...
schtasks /delete /tn "%nombre%" /f
echo Tarea eliminada.
pause
goto menu_principal

:modificar_tarea
echo.
set /p nombre="Nombre de la tarea a modificar: "
set /p nuevo_comando="Nuevo comando: "
echo.
echo Modificando tarea %nombre%...
schtasks /change /tn "%nombre%" /tr "%nuevo_comando%"
echo Tarea modificada.
pause
goto menu_principal

:tarea_backup
echo.
set /p nombre="Nombre de la tarea de backup: "
set /p origen="Directorio origen: "
set /p destino="Directorio destino: "
set /p hora="Hora de backup (HH:MM): "

:: Crear script de backup
echo @echo off > "backup_%nombre%.bat"
echo echo Iniciando backup... >> "backup_%nombre%.bat"
echo robocopy "%origen%" "%destino%" /MIR /R:3 /W:10 /LOG:backup_%nombre%.log >> "backup_%nombre%.bat"
echo echo Backup completado. >> "backup_%nombre%.bat"

:: Crear tarea programada
schtasks /create /tn "%nombre%" /tr "%~dp0backup_%nombre%.bat" /sc daily /st %hora%

echo Tarea de backup creada: %nombre%
echo Script generado: backup_%nombre%.bat
pause
goto menu_principal

:tarea_limpieza
echo.
set /p nombre="Nombre de la tarea de limpieza: "
set /p directorio="Directorio a limpiar: "
set /p dias="Archivos más antiguos que (días): "

:: Crear script de limpieza
echo @echo off > "limpieza_%nombre%.bat"
echo echo Iniciando limpieza... >> "limpieza_%nombre%.bat"
echo forfiles /p "%directorio%" /s /m *.* /d -%dias% /c "cmd /c del @path" >> "limpieza_%nombre%.bat"
echo echo Limpieza completada. >> "limpieza_%nombre%.bat"

:: Crear tarea programada
schtasks /create /tn "%nombre%" /tr "%~dp0limpieza_%nombre%.bat" /sc weekly /d SUN /st "01:00"

echo Tarea de limpieza creada: %nombre%
echo Script generado: limpieza_%nombre%.bat
pause
goto menu_principal

:tarea_monitoreo
echo.
set /p nombre="Nombre de la tarea de monitoreo: "
set /p intervalo="Intervalo (minutos): "

:: Crear script de monitoreo
echo @echo off > "monitor_%nombre%.bat"
echo echo Monitoreando sistema... >> "monitor_%nombre%.bat"
echo systeminfo ^| findstr /C:"Total Physical Memory" /C:"Available Physical Memory" >> "monitor_%nombre%.bat"
echo tasklist ^| findstr /C:"chrome.exe" /C:"firefox.exe" >> "monitor_%nombre%.bat"
echo echo Monitoreo completado. >> "monitor_%nombre%.bat"

:: Crear tarea programada
schtasks /create /tn "%nombre%" /tr "%~dp0monitor_%nombre%.bat" /sc minute /mo %intervalo%

echo Tarea de monitoreo creada: %nombre%
echo Script generado: monitor_%nombre%.bat
pause
goto menu_principal

:exportar_config
echo.
set /p archivo="Nombre del archivo de exportación: "
echo.
echo Exportando configuración de tareas...
schtasks /query /fo csv > "%archivo%.csv"
echo Configuración exportada a: %archivo%.csv
pause
goto menu_principal

:salir
echo.
echo ¡Hasta luego!
exit /b 0
```

### Script para Sistema de Automatización Completa

```batch
@echo off
setlocal enabledelayedexpansion
title Sistema de Automatización Completa
color 0C

:: Configuración
set "config_dir=%~dp0config"
set "scripts_dir=%~dp0scripts"
set "logs_dir=%~dp0logs"

:: Crear directorios si no existen
if not exist "%config_dir%" mkdir "%config_dir%"
if not exist "%scripts_dir%" mkdir "%scripts_dir%"
if not exist "%logs_dir%" mkdir "%logs_dir%"

:: Archivo de configuración
set "config_file=%config_dir%\automatizacion.conf"

:: Crear configuración por defecto si no existe
if not exist "%config_file%" (
    echo # Configuración de automatización > "%config_file%"
    echo # Formato: categoria|nombre|comando|frecuencia|hora|activo >> "%config_file%"
    echo backup|backup_diario|C:\scripts\backup.bat|daily|02:00|1 >> "%config_file%"
    echo limpieza|limpieza_semanal|C:\scripts\limpieza.bat|weekly|01:00|1 >> "%config_file%"
    echo monitoreo|monitoreo_continuo|C:\scripts\monitor.bat|minute|30|1 >> "%config_file%"
    echo reporte|reporte_mensual|C:\scripts\reporte.bat|monthly|09:00|1 >> "%config_file%"
)

:: Función de logging
:log
echo [%date% %time%] %~1 >> "%logs_dir%\automatizacion.log"
goto :eof

:: Función para mostrar menú principal
:mostrar_menu
cls
echo.
echo ========================================
echo    SISTEMA DE AUTOMATIZACIÓN COMPLETA
echo ========================================
echo.
echo [1] Configurar automatizaciones
echo [2] Crear tareas desde configuración
echo [3] Monitorear tareas activas
echo [4] Generar reportes de ejecución
echo [5] Backup de configuraciones
echo [6] Restaurar configuraciones
echo [7] Limpiar tareas antiguas
echo [8] Ver logs del sistema
echo [9] Salir
echo.
set /p opcion="Selecciona una opción: "
goto :eof

:: Función para configurar automatizaciones
:configurar_automatizaciones
echo.
echo Configuraciones actuales:
echo -------------------------
for /f "tokens=1-6 delims=|" %%a in (%config_file%) do (
    if not "%%a"=="#" (
        echo Categoría: %%a
        echo Nombre: %%b
        echo Comando: %%c
        echo Frecuencia: %%d
        echo Hora: %%e
        echo Activo: %%f
        echo -------------------------
    )
)
echo.
echo [1] Agregar nueva configuración
echo [2] Editar configuración existente
echo [3] Eliminar configuración
echo [4] Volver al menú principal
echo.
set /p sub_opcion="Selecciona una opción: "

if "%sub_opcion%"=="1" goto agregar_config
if "%sub_opcion%"=="2" goto editar_config
if "%sub_opcion%"=="3" goto eliminar_config
if "%sub_opcion%"=="4" goto menu_principal
goto configurar_automatizaciones

:agregar_config
echo.
set /p categoria="Categoría: "
set /p nombre="Nombre: "
set /p comando="Comando: "
set /p frecuencia="Frecuencia (daily/weekly/monthly/minute): "
set /p hora="Hora (HH:MM): "
echo %categoria%^|%nombre%^|%comando%^|%frecuencia%^|%hora%^|1 >> "%config_file%"
call :log "Nueva configuración agregada: %nombre%"
echo Configuración agregada exitosamente.
pause
goto configurar_automatizaciones

:editar_config
echo.
set /p nombre_editar="Nombre de la configuración a editar: "
set "temp_file=%temp%\temp_config.txt"
if exist "%temp_file%" del "%temp_file%"

for /f "tokens=1-6 delims=|" %%a in (%config_file%) do (
    if "%%b"=="%nombre_editar%" (
        set /p nueva_categoria="Nueva categoría [%%a]: "
        set /p nuevo_comando="Nuevo comando [%%c]: "
        set /p nueva_frecuencia="Nueva frecuencia [%%d]: "
        set /p nueva_hora="Nueva hora [%%e]: "
        
        if "!nueva_categoria!"=="" set "nueva_categoria=%%a"
        if "!nuevo_comando!"=="" set "nuevo_comando=%%c"
        if "!nueva_frecuencia!"=="" set "nueva_frecuencia=%%d"
        if "!nueva_hora!"=="" set "nueva_hora=%%e"
        
        echo !nueva_categoria!^|%%b^|!nuevo_comando!^|!nueva_frecuencia!^|!nueva_hora!^|%%f >> "%temp_file%"
        call :log "Configuración editada: %nombre_editar%"
    ) else (
        echo %%a^|%%b^|%%c^|%%d^|%%e^|%%f >> "%temp_file%"
    )
)
move /y "%temp_file%" "%config_file%" >nul
echo Configuración editada exitosamente.
pause
goto configurar_automatizaciones

:eliminar_config
echo.
set /p nombre_eliminar="Nombre de la configuración a eliminar: "
set "temp_file=%temp%\temp_config.txt"
if exist "%temp_file%" del "%temp_file%"

for /f "tokens=1-6 delims=|" %%a in (%config_file%) do (
    if not "%%b"=="%nombre_eliminar%" (
        echo %%a^|%%b^|%%c^|%%d^|%%e^|%%f >> "%temp_file%"
    )
)
move /y "%temp_file%" "%config_file%" >nul
call :log "Configuración eliminada: %nombre_eliminar%"
echo Configuración eliminada exitosamente.
pause
goto configurar_automatizaciones

:: Función para crear tareas desde configuración
:crear_tareas_desde_config
echo.
echo Creando tareas desde configuración...
for /f "tokens=1-6 delims=|" %%a in (%config_file%) do (
    if not "%%a"=="#" (
        if "%%f"=="1" (
            echo Creando tarea: %%b
            schtasks /create /tn "%%b" /tr "%%c" /sc %%d /st %%e /f 2>nul
            if errorlevel 1 (
                echo Error al crear tarea: %%b
                call :log "Error al crear tarea: %%b"
            ) else (
                echo Tarea creada exitosamente: %%b
                call :log "Tarea creada: %%b"
            )
        )
    )
)
echo.
echo Proceso completado.
pause
goto menu_principal

:: Función para monitorear tareas activas
:monitorear_tareas
echo.
echo Monitoreando tareas activas...
echo Presiona Ctrl+C para detener
echo.

:monitoreo_loop
cls
echo ========================================
echo    MONITOREO DE TAREAS ACTIVAS
echo    Hora: %time%
echo ========================================
echo.

for /f "tokens=1-6 delims=|" %%a in (%config_file%) do (
    if not "%%a"=="#" (
        if "%%f"=="1" (
            echo Tarea: %%b
            echo Estado: 
            schtasks /query /tn "%%b" 2>nul | findstr "Ready"
            if errorlevel 1 (
                echo Estado: No encontrada o con error
            )
            echo -------------------------
        )
    )
)

echo Actualizando en 60 segundos...
timeout /t 60 /nobreak >nul
goto monitoreo_loop

:: Función para generar reportes
:generar_reportes
echo.
set /p reporte_nombre="Nombre del reporte: "
echo.
echo Generando reporte de ejecución...

echo Reporte de Tareas Programadas > "%logs_dir%\%reporte_nombre%.txt"
echo Fecha: %date% %time% >> "%logs_dir%\%reporte_nombre%.txt"
echo ======================================== >> "%logs_dir%\%reporte_nombre%.txt"
echo. >> "%logs_dir%\%reporte_nombre%.txt"

schtasks /query /fo table >> "%logs_dir%\%reporte_nombre%.txt"

echo Reporte generado: %logs_dir%\%reporte_nombre%.txt
call :log "Reporte generado: %reporte_nombre%"
pause
goto menu_principal

:: Función para backup de configuraciones
:backup_configuraciones
echo.
set "backup_file=backup_automatizacion_%date:~-4,4%%date:~-10,2%%date:~-7,2%_%time:~0,2%%time:~3,2%.zip"
echo Creando backup de configuraciones...
powershell -command "Compress-Archive -Path '%config_dir%', '%scripts_dir%' -DestinationPath '%logs_dir%\%backup_file%'"
echo Backup creado: %logs_dir%\%backup_file%
call :log "Backup creado: %backup_file%"
pause
goto menu_principal

:: Función para restaurar configuraciones
:restaurar_configuraciones
echo.
set /p backup_file="Archivo de backup a restaurar: "
echo Restaurando configuraciones...
powershell -command "Expand-Archive -Path '%backup_file%' -DestinationPath '%~dp0' -Force"
echo Configuraciones restauradas.
call :log "Configuraciones restauradas desde: %backup_file%"
pause
goto menu_principal

:: Función para limpiar tareas antiguas
:limpiar_tareas_antiguas
echo.
set /p dias="Eliminar tareas más antiguas que (días): "
echo.
echo Limpiando tareas antiguas...

for /f "tokens=1-6 delims=|" %%a in (%config_file%) do (
    if not "%%a"=="#" (
        echo Verificando tarea: %%b
        schtasks /query /tn "%%b" 2>nul | findstr "Ready"
        if errorlevel 1 (
            echo Eliminando tarea no encontrada: %%b
            schtasks /delete /tn "%%b" /f 2>nul
        )
    )
)

echo Limpieza completada.
call :log "Limpieza de tareas antiguas completada"
pause
goto menu_principal

:: Función para ver logs
:ver_logs
echo.
echo Últimas 30 entradas del log:
echo -----------------------------
for /f "skip=-30" %%a in ("%logs_dir%\automatizacion.log") do echo %%a
pause
goto menu_principal

:: Menú principal
:menu_principal
call :mostrar_menu

if "%opcion%"=="1" goto configurar_automatizaciones
if "%opcion%"=="2" goto crear_tareas_desde_config
if "%opcion%"=="3" goto monitorear_tareas
if "%opcion%"=="4" goto generar_reportes
if "%opcion%"=="5" goto backup_configuraciones
if "%opcion%"=="6" goto restaurar_configuraciones
if "%opcion%"=="7" goto limpiar_tareas_antiguas
if "%opcion%"=="8" goto ver_logs
if "%opcion%"=="9" goto salir

goto menu_principal

:salir
echo.
echo ¡Hasta luego!
exit /b 0
```

## Consejos Importantes

### 🔒 **Seguridad**
- Usa cuentas con privilegios mínimos necesarios para cada tarea
- Revisa regularmente las tareas programadas en busca de actividades sospechosas
- Implementa logging detallado para auditorías de seguridad
- Usa credenciales seguras y cámbialas periódicamente

### ⚡ **Optimización**
- Programa tareas críticas en horarios de baja actividad del sistema
- Usa triggers inteligentes para evitar ejecuciones innecesarias
- Implementa timeouts apropiados para evitar tareas colgadas
- Monitorea el rendimiento del sistema durante ejecuciones masivas

### 🛠️ **Mejores Prácticas**
- Documenta todas las tareas programadas y su propósito
- Implementa manejo de errores en scripts de automatización
- Crea backups de configuraciones antes de cambios masivos
- Usa nombres descriptivos para facilitar la gestión

## Casos de Uso Reales

### 🏢 **Administración de Sistemas**
- Backups automáticos de bases de datos y archivos críticos
- Limpieza programada de logs y archivos temporales
- Monitoreo continuo de servicios y recursos del sistema
- Actualizaciones automáticas de software y parches

### 🎓 **Educación**
- Limpieza automática de laboratorios de computación
- Backup de trabajos de estudiantes
- Monitoreo de uso de recursos educativos
- Generación automática de reportes académicos

### 🏭 **Empresa**
- Sincronización automática de datos entre sucursales
- Generación de reportes financieros y operativos
- Mantenimiento preventivo de sistemas críticos
- Gestión automática de licencias y recursos

## Conclusión y Siguiente Paso

¡Increíble! Has dominado el arte de la automatización con el Programador de Tareas de Windows. Ahora tu sistema puede trabajar de forma inteligente y autónoma, ejecutando tareas críticas en el momento perfecto sin intervención humana.

En el próximo capítulo, aprenderás sobre la **Gestión de un servidor FTP**, una habilidad fundamental para la transferencia segura de archivos en redes corporativas. Descubrirás cómo configurar, gestionar y mantener servidores FTP robustos para compartir archivos de manera eficiente y segura.

---

## Enlaces Relacionados

- [Capítulo 41: Escritorio Remoto](41.%20Escritorio%20Remoto.md)
- [Capítulo 43: Gestión de un servidor FTP](43.%20Gestión%20de%20un%20servidor%20FTP.md)
- [Capítulo 34: Gestión de Procesos](34.%20Gestión%20de%20Procesos.md)
- [Capítulo 31: Apagar, Reiniciar y Cerrar sesión](31.%20Apagar,%20Reiniciar%20y%20Cerrar%20sesión.md)

## Fuentes y Referencias

- [Windows Task Scheduler](https://docs.microsoft.com/en-us/windows/win32/taskschd/task-scheduler-start-page)
- [SCHTASKS Command Reference](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks)
- [Task Scheduler Best Practices](https://docs.microsoft.com/en-us/windows/win32/taskschd/task-scheduler-best-practices)
- [Automation and Scripting](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/automation-and-scripting)

---

**Autor:** Jerson Martínez  
**Sitio web:** [jersonmartinez.com](https://jersonmartinez.com)  
**Blog DevOps:** [crashell.com](https://crashell.com) 