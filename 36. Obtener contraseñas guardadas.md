# 36. Obtener contraseñas guardadas

> *"Las contraseñas son las llaves digitales de nuestro mundo. ¿Sabías que Windows almacena muchas contraseñas de forma segura y puedes recuperarlas desde la línea de comandos cuando sea necesario?"* 🔑

## Introducción

En el mundo digital actual, las contraseñas son fundamentales para acceder a servicios, aplicaciones y recursos del sistema. Windows almacena estas credenciales de manera segura en diferentes ubicaciones, y como administrador de sistemas, necesitas saber cómo recuperarlas cuando sea necesario.

¿Te imaginas un servidor crítico donde el administrador anterior no dejó documentación de las contraseñas? ¿O una aplicación empresarial que requiere credenciales específicas que se perdieron? Estas son situaciones reales donde la capacidad de recuperar contraseñas guardadas puede ser crucial para mantener la operatividad del sistema.

En este capítulo, aprenderás técnicas profesionales para recuperar y gestionar contraseñas almacenadas en Windows, desde credenciales del sistema hasta contraseñas de aplicaciones.

## Conceptos Clave

### 🔑 **Credenciales Guardadas**
Información de autenticación almacenada de forma segura en el sistema Windows.

### 🛡️ **Administrador de Credenciales**
Sistema integrado de Windows para gestionar contraseñas y credenciales.

### 🔐 **Cifrado de Contraseñas**
Proceso de protección de contraseñas mediante algoritmos de encriptación.

### 📋 **Política de Seguridad**
Conjunto de reglas que definen cómo se manejan las credenciales en el sistema.

## Comandos y herramientas principales

### `CMDKEY`
Comando principal para gestionar credenciales almacenadas en Windows de manera segura.

**Sintaxis básica:**
```batch
cmdkey [opciones]
```

**Parámetros principales:**
- `/list` - Listar todas las credenciales almacenadas en el sistema
- `/add:target` - Agregar nueva credencial para un objetivo específico
- `/delete:target` - Eliminar credencial específica por nombre de objetivo
- `/generic:target` - Especificar credencial genérica para un objetivo
- `/user:username` - Especificar nombre de usuario para la credencial
- `/pass:password` - Especificar contraseña para la credencial
- `/smartcard` - Usar credencial de tarjeta inteligente

### `POWERSHELL` (Get-StoredCredential)
Cmdlet de PowerShell para acceder y gestionar credenciales almacenadas de manera avanzada.

**Sintaxis:**
```powershell
Get-StoredCredential -Target "nombre_servicio"
Add-StoredCredential -Target "servidor" -UserName "usuario" -Password "contraseña"
Remove-StoredCredential -Target "servidor"
```

### `REG QUERY`
Comando para consultar el registro de Windows donde se almacenan algunas credenciales y configuraciones de seguridad.

**Sintaxis:**
```batch
reg query [ruta_clave] /v [nombre_valor]
reg query "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Credentials" /s
```

**Parámetros:**
- `ruta_clave` - Ruta de la clave del registro a consultar
- `/v nombre_valor` - Nombre específico del valor a consultar
- `/s` - Buscar recursivamente en subclaves

### `CERTUTIL`
Comando para gestionar certificados digitales y credenciales relacionadas con PKI.

**Sintaxis:**
```batch
certutil [opciones] [archivo]
certutil -store MY
certutil -dump [archivo_certificado]
```

**Opciones comunes:**
- `-store` - Mostrar certificados en un almacén específico
- `-dump` - Mostrar información detallada de un certificado
- `-export` - Exportar certificado a archivo
- `-import` - Importar certificado desde archivo

### Comandos adicionales utilizados
- `FINDSTR` - Buscar patrones específicos en la salida de comandos
- `FOR /F` - Procesar archivos línea por línea para automatización
- `IF` - Condiciones en scripts para verificar resultados
- `PAUSE` - Pausar ejecución del script
- `ECHO` - Mostrar mensajes informativos
- `DATE` - Obtener fecha actual para nombres de archivos
- `TIME` - Obtener hora actual para timestamps

## Ejemplos Prácticos

### 1. **Listar Credenciales Guardadas**
**Propósito:** Ver todas las credenciales almacenadas en el sistema.

```batch
cmdkey /list
```

**Casos de uso reales:**
- Auditoría de credenciales del sistema
- Verificación de cuentas almacenadas
- Diagnóstico de problemas de autenticación

### 2. **Agregar Nueva Credencial**
**Propósito:** Almacenar una nueva credencial para uso posterior.

```batch
cmdkey /add:servidor.local /user:administrador /pass:MiContraseña123
```

**Casos de uso reales:**
- Configuración de acceso a servidores remotos
- Automatización de scripts que requieren autenticación
- Gestión de credenciales de servicios

### 3. **Eliminar Credencial Específica**
**Propósito:** Remover una credencial almacenada del sistema.

```batch
cmdkey /delete:servidor.local
```

**Casos de uso reales:**
- Limpieza de credenciales obsoletas
- Rotación de credenciales de seguridad
- Mantenimiento de credenciales del sistema

### 4. **Buscar Credenciales por Patrón**
**Propósito:** Encontrar credenciales que coincidan con un patrón específico.

```batch
cmdkey /list | findstr "servidor"
```

**Casos de uso reales:**
- Búsqueda de credenciales específicas
- Auditoría de acceso a servidores
- Verificación de configuración de red

### 5. **Exportar Credenciales a Archivo**
**Propósito:** Guardar la lista de credenciales en un archivo para auditoría.

```batch
cmdkey /list > credenciales_%date:~-4,4%%date:~-10,2%%date:~-7,2%.txt
```

**Casos de uso reales:**
- Auditorías de seguridad
- Documentación de credenciales
- Backup de configuración

### 6. **Verificar Credenciales de Red**
**Propósito:** Comprobar credenciales almacenadas para conexiones de red.

```batch
cmdkey /list | findstr "TERMSRV"
```

**Casos de uso reales:**
- Diagnóstico de problemas de RDP
- Verificación de acceso remoto
- Gestión de conexiones de escritorio remoto

### 7. **Gestionar Credenciales de Dominio**
**Propósito:** Administrar credenciales relacionadas con el dominio de Active Directory.

```batch
cmdkey /list | findstr "DOMAIN"
```

**Casos de uso reales:**
- Gestión de credenciales corporativas
- Verificación de autenticación de dominio
- Auditoría de acceso a recursos de red

### 8. **Limpiar Credenciales Expiradas**
**Propósito:** Eliminar credenciales que ya no son válidas o están expiradas.

```batch
for /f "tokens=1,2 delims= " %%a in ('cmdkey /list ^| findstr "EXPIRO"') do cmdkey /delete:%%b
```

**Casos de uso reales:**
- Mantenimiento de seguridad
- Limpieza automática de credenciales
- Optimización del sistema

### 9. **Verificar Credenciales de Servicios**
**Propósito:** Comprobar credenciales utilizadas por servicios del sistema.

```batch
cmdkey /list | findstr "SERVICE"
```

**Casos de uso reales:**
- Diagnóstico de servicios que fallan
- Verificación de cuentas de servicio
- Auditoría de servicios críticos

### 10. **Backup de Credenciales**
**Propósito:** Crear una copia de seguridad de las credenciales del sistema.

```batch
echo === BACKUP DE CREDENCIALES === > backup_credenciales.txt
echo Fecha: %date% %time% >> backup_credenciales.txt
cmdkey /list >> backup_credenciales.txt
```

**Casos de uso reales:**
- Preparación para migración de sistemas
- Documentación de configuración
- Recuperación ante desastres



## Consejos Importantes

### ⚡ **Optimización**
- Revisa regularmente las credenciales almacenadas
- Elimina credenciales obsoletas o expiradas
- Mantén un inventario actualizado de credenciales

### 🛡️ **Seguridad**
- Usa credenciales fuertes y únicas
- Implementa rotación regular de contraseñas
- Documenta cambios en credenciales críticas

### 🔧 **Mejores Prácticas**
- Usa cmdkey para gestión programática de credenciales
- Implementa auditorías regulares de credenciales
- Mantén backups de configuración de credenciales

## Casos de Uso Reales

### 🏢 **Administración de Sistemas**
- Gestión de credenciales de servidores
- Automatización de scripts con autenticación
- Recuperación de credenciales perdidas

### 🏫 **Entornos Educativos**
- Gestión de credenciales de laboratorios
- Configuración de acceso a recursos educativos
- Auditoría de credenciales de estudiantes

### 🏭 **Entornos Empresariales**
- Gestión de credenciales corporativas
- Cumplimiento de políticas de seguridad
- Recuperación ante incidentes

## Conclusión y Siguiente Paso

Has aprendido a gestionar credenciales guardadas de manera profesional y segura. Ahora puedes recuperar, administrar y auditar las contraseñas almacenadas en el sistema Windows de manera eficiente.

En el siguiente capítulo, exploraremos cómo **Crear red hospedada**, donde aprenderás a configurar y gestionar redes virtuales desde la línea de comandos. ¿Te imaginas creando redes de prueba para desarrollo o configurando entornos de aislamiento para seguridad? ¡Esa será tu próxima habilidad!

---

## Enlaces Relacionados

- [Capítulo 35: Conexiones de red](35.%20Conexiones%20de%20red.md)
- [Capítulo 37: Crear red hospedada](37.%20Crear%20red%20hospedada.md)
- [Capítulo 40: Ejecutar como Administrador - RUNAS](40.%20Ejecutar%20como%20Administrador%20-%20RUNAS.md)

## Fuentes y Referencias

- **Documentación oficial de Microsoft:** [Cmdkey Command](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmdkey)
- **Windows Command Line Reference:** [Credential Management](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands)
- **Administración de Windows Server:** [Credential Management](https://docs.microsoft.com/en-us/windows-server/administration/)

---

## Scripts disponibles

En el directorio `scripts/36-obtener-contrasenas-guardadas/` encontrarás los siguientes scripts para gestionar credenciales almacenadas de manera segura:

### 🔑 **Gestión de credenciales**
- **`gestor-avanzado-credenciales.bat`** - Interfaz completa para ver, agregar, eliminar, buscar y auditar credenciales del sistema
- **`recuperacion-emergencia-credenciales.bat`** - Herramienta de emergencia para recuperar credenciales críticas en situaciones de crisis

### 📋 **Instrucciones de uso**

1. **Para gestión normal de credenciales:**
   ```batch
   cd scripts\36-obtener-contrasenas-guardadas
   gestor-avanzado-credenciales.bat
   ```

2. **Para situaciones de emergencia:**
   ```batch
   cd scripts\36-obtener-contrasenas-guardadas
   recuperacion-emergencia-credenciales.bat
   ```

### ⚠️ **Notas importantes**
- Ejecuta estos scripts como administrador para acceso completo
- Ten cuidado al eliminar credenciales - verifica que no sean necesarias
- Los backups se guardan en archivos de texto con timestamp
- Documenta todas las operaciones realizadas para auditoría

### 🔒 **Seguridad**
- El script de emergencia identifica credenciales críticas automáticamente
- Incluye verificaciones de seguridad antes de eliminar credenciales
- Genera reportes detallados para auditoría y cumplimiento
- Permite limpieza selectiva de credenciales obsoletas

---

**Autor:** Jerson Martínez  
**Sitio web:** [jersonmartinez.com](https://jersonmartinez.com)  
**Blog DevOps:** [crashell.com](https://crashell.com) 