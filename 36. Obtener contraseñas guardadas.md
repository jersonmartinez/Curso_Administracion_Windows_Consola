# 36. Obtener contrase√±as guardadas

> *"Las contrase√±as son las llaves digitales de nuestro mundo. ¬øSab√≠as que Windows almacena muchas contrase√±as de forma segura y puedes recuperarlas desde la l√≠nea de comandos cuando sea necesario?"* üîë

## Introducci√≥n

En el mundo digital actual, las contrase√±as son fundamentales para acceder a servicios, aplicaciones y recursos del sistema. Windows almacena estas credenciales de manera segura en diferentes ubicaciones, y como administrador de sistemas, necesitas saber c√≥mo recuperarlas cuando sea necesario.

¬øTe imaginas un servidor cr√≠tico donde el administrador anterior no dej√≥ documentaci√≥n de las contrase√±as? ¬øO una aplicaci√≥n empresarial que requiere credenciales espec√≠ficas que se perdieron? Estas son situaciones reales donde la capacidad de recuperar contrase√±as guardadas puede ser crucial para mantener la operatividad del sistema.

En este cap√≠tulo, aprender√°s t√©cnicas profesionales para recuperar y gestionar contrase√±as almacenadas en Windows, desde credenciales del sistema hasta contrase√±as de aplicaciones.

## Conceptos Clave

### üîë **Credenciales Guardadas**
Informaci√≥n de autenticaci√≥n almacenada de forma segura en el sistema Windows.

### üõ°Ô∏è **Administrador de Credenciales**
Sistema integrado de Windows para gestionar contrase√±as y credenciales.

### üîê **Cifrado de Contrase√±as**
Proceso de protecci√≥n de contrase√±as mediante algoritmos de encriptaci√≥n.

### üìã **Pol√≠tica de Seguridad**
Conjunto de reglas que definen c√≥mo se manejan las credenciales en el sistema.

## Comandos Principales

### `CMDKEY`
Comando para gestionar credenciales almacenadas en Windows.

**Sintaxis b√°sica:**
```batch
cmdkey [opciones]
```

**Opciones principales:**
- `/list` - Listar credenciales almacenadas
- `/add` - Agregar nueva credencial
- `/delete` - Eliminar credencial espec√≠fica
- `/generic` - Especificar credencial gen√©rica

### `POWERSHELL` (Get-StoredCredential)
Comando de PowerShell para acceder a credenciales almacenadas.

**Sintaxis:**
```powershell
Get-StoredCredential -Target "nombre_servicio"
```

### `REG QUERY`
Comando para consultar el registro de Windows donde se almacenan algunas credenciales.

**Sintaxis:**
```batch
reg query [ruta_clave] /v [nombre_valor]
```

### `CERTUTIL`
Comando para gestionar certificados y credenciales relacionadas.

**Sintaxis:**
```batch
certutil [opciones] [archivo]
```

## Ejemplos Pr√°cticos

### 1. **Listar Credenciales Guardadas**
**Prop√≥sito:** Ver todas las credenciales almacenadas en el sistema.

```batch
cmdkey /list
```

**Casos de uso reales:**
- Auditor√≠a de credenciales del sistema
- Verificaci√≥n de cuentas almacenadas
- Diagn√≥stico de problemas de autenticaci√≥n

### 2. **Agregar Nueva Credencial**
**Prop√≥sito:** Almacenar una nueva credencial para uso posterior.

```batch
cmdkey /add:servidor.local /user:administrador /pass:MiContrase√±a123
```

**Casos de uso reales:**
- Configuraci√≥n de acceso a servidores remotos
- Automatizaci√≥n de scripts que requieren autenticaci√≥n
- Gesti√≥n de credenciales de servicios

### 3. **Eliminar Credencial Espec√≠fica**
**Prop√≥sito:** Remover una credencial almacenada del sistema.

```batch
cmdkey /delete:servidor.local
```

**Casos de uso reales:**
- Limpieza de credenciales obsoletas
- Rotaci√≥n de credenciales de seguridad
- Mantenimiento de credenciales del sistema

### 4. **Buscar Credenciales por Patr√≥n**
**Prop√≥sito:** Encontrar credenciales que coincidan con un patr√≥n espec√≠fico.

```batch
cmdkey /list | findstr "servidor"
```

**Casos de uso reales:**
- B√∫squeda de credenciales espec√≠ficas
- Auditor√≠a de acceso a servidores
- Verificaci√≥n de configuraci√≥n de red

### 5. **Exportar Credenciales a Archivo**
**Prop√≥sito:** Guardar la lista de credenciales en un archivo para auditor√≠a.

```batch
cmdkey /list > credenciales_%date:~-4,4%%date:~-10,2%%date:~-7,2%.txt
```

**Casos de uso reales:**
- Auditor√≠as de seguridad
- Documentaci√≥n de credenciales
- Backup de configuraci√≥n

### 6. **Verificar Credenciales de Red**
**Prop√≥sito:** Comprobar credenciales almacenadas para conexiones de red.

```batch
cmdkey /list | findstr "TERMSRV"
```

**Casos de uso reales:**
- Diagn√≥stico de problemas de RDP
- Verificaci√≥n de acceso remoto
- Gesti√≥n de conexiones de escritorio remoto

### 7. **Gestionar Credenciales de Dominio**
**Prop√≥sito:** Administrar credenciales relacionadas con el dominio de Active Directory.

```batch
cmdkey /list | findstr "DOMAIN"
```

**Casos de uso reales:**
- Gesti√≥n de credenciales corporativas
- Verificaci√≥n de autenticaci√≥n de dominio
- Auditor√≠a de acceso a recursos de red

### 8. **Limpiar Credenciales Expiradas**
**Prop√≥sito:** Eliminar credenciales que ya no son v√°lidas o est√°n expiradas.

```batch
for /f "tokens=1,2 delims= " %%a in ('cmdkey /list ^| findstr "EXPIRO"') do cmdkey /delete:%%b
```

**Casos de uso reales:**
- Mantenimiento de seguridad
- Limpieza autom√°tica de credenciales
- Optimizaci√≥n del sistema

### 9. **Verificar Credenciales de Servicios**
**Prop√≥sito:** Comprobar credenciales utilizadas por servicios del sistema.

```batch
cmdkey /list | findstr "SERVICE"
```

**Casos de uso reales:**
- Diagn√≥stico de servicios que fallan
- Verificaci√≥n de cuentas de servicio
- Auditor√≠a de servicios cr√≠ticos

### 10. **Backup de Credenciales**
**Prop√≥sito:** Crear una copia de seguridad de las credenciales del sistema.

```batch
echo === BACKUP DE CREDENCIALES === > backup_credenciales.txt
echo Fecha: %date% %time% >> backup_credenciales.txt
cmdkey /list >> backup_credenciales.txt
```

**Casos de uso reales:**
- Preparaci√≥n para migraci√≥n de sistemas
- Documentaci√≥n de configuraci√≥n
- Recuperaci√≥n ante desastres

## Scripts Avanzados

### Script para Gesti√≥n Avanzada de Credenciales

```batch
@echo off
:: Gestor avanzado de credenciales guardadas
title üîë Gestor de Credenciales
color 0A

:menu
cls
echo ========================================
echo    üîë GESTOR AVANZADO DE CREDENCIALES
echo ========================================
echo.
echo 1. üëÅÔ∏è Ver credenciales
echo 2. ‚ûï Agregar credencial
echo 3. ‚ùå Eliminar credencial
echo 4. üîç Buscar credencial
echo 5. üìä Auditor√≠a de credenciales
echo 6. üíæ Backup de credenciales
echo 7. üßπ Limpiar credenciales
echo 8. üö™ Salir
echo.
set /p opcion="Selecciona una opci√≥n: "

if "%opcion%"=="1" goto ver_credenciales
if "%opcion%"=="2" goto agregar_credencial
if "%opcion%"=="3" goto eliminar_credencial
if "%opcion%"=="4" goto buscar_credencial
if "%opcion%"=="5" goto auditoria_credenciales
if "%opcion%"=="6" goto backup_credenciales
if "%opcion%"=="7" goto limpiar_credenciales
if "%opcion%"=="8" goto salir
goto menu

:ver_credenciales
cls
echo ========================================
echo         üëÅÔ∏è VER CREDENCIALES
echo ========================================
echo.
echo üîç Listando credenciales almacenadas...
cmdkey /list
echo.
pause
goto menu

:agregar_credencial
cls
echo ========================================
echo         ‚ûï AGREGAR CREDENCIAL
echo ========================================
echo.
set /p target="Nombre del objetivo (ej: servidor.local): "
set /p username="Nombre de usuario: "
set /p password="Contrase√±a: "
if defined target if defined username if defined password (
    echo üîÑ Agregando credencial...
    cmdkey /add:%target% /user:%username% /pass:%password%
    echo ‚úÖ Credencial agregada
) else (
    echo ‚ùå Datos incompletos
)
pause
goto menu

:eliminar_credencial
cls
echo ========================================
echo         ‚ùå ELIMINAR CREDENCIAL
echo ========================================
echo.
echo üîç Credenciales disponibles:
cmdkey /list
echo.
set /p target="Nombre del objetivo a eliminar: "
if defined target (
    echo ‚ö†Ô∏è ¬øEliminar credencial %target%?
    set /p confirm="(S/N): "
    if /i "%confirm%"=="S" (
        cmdkey /delete:%target%
        echo ‚úÖ Credencial eliminada
    ) else (
        echo ‚ùå Operaci√≥n cancelada
    )
) else (
    echo ‚ùå Objetivo no especificado
)
pause
goto menu

:buscar_credencial
cls
echo ========================================
echo         üîç BUSCAR CREDENCIAL
echo ========================================
echo.
set /p patron="Patr√≥n de b√∫squeda: "
if defined patron (
    echo üîç Buscando credenciales que coincidan con: %patron%
    cmdkey /list | findstr /i "%patron%"
) else (
    echo ‚ùå Patr√≥n no especificado
)
pause
goto menu

:auditoria_credenciales
cls
echo ========================================
echo         üìä AUDITOR√çA DE CREDENCIALES
echo ========================================
echo.
echo üîç Realizando auditor√≠a de credenciales...
echo.
echo === CREDENCIALES DE RED ===
cmdkey /list | findstr /i "TERMSRV\|DOMAIN"
echo.
echo === CREDENCIALES DE SERVICIOS ===
cmdkey /list | findstr /i "SERVICE\|SYSTEM"
echo.
echo === CREDENCIALES GEN√âRICAS ===
cmdkey /list | findstr /i "GENERIC"
echo.
echo === TOTAL DE CREDENCIALES ===
cmdkey /list | find /c "Objetivo"
pause
goto menu

:backup_credenciales
cls
echo ========================================
echo         üíæ BACKUP DE CREDENCIALES
echo ========================================
echo.
echo üîÑ Creando backup de credenciales...
set archivo=backup_credenciales_%date:~-4,4%%date:~-10,2%%date:~-7,2%_%time:~0,2%%time:~3,2%.txt
echo === BACKUP DE CREDENCIALES === > %archivo%
echo Fecha: %date% %time% >> %archivo%
echo. >> %archivo%
cmdkey /list >> %archivo%
echo ‚úÖ Backup creado en %archivo%
pause
goto menu

:limpiar_credenciales
cls
echo ========================================
echo         üßπ LIMPIAR CREDENCIALES
echo ========================================
echo.
echo ‚ö†Ô∏è ADVERTENCIA: Esta operaci√≥n eliminar√° credenciales obsoletas
echo.
echo 1. Limpiar credenciales de red obsoletas
echo 2. Limpiar credenciales de servicios
echo 3. Limpiar todas las credenciales
echo.
set /p tipo="Selecciona tipo de limpieza: "

if "%tipo%"=="1" (
    echo üîÑ Limpiando credenciales de red obsoletas...
    for /f "tokens=1,2 delims= " %%a in ('cmdkey /list ^| findstr "TERMSRV"') do (
        echo Eliminando: %%b
        cmdkey /delete:%%b
    )
) else if "%tipo%"=="2" (
    echo üîÑ Limpiando credenciales de servicios...
    for /f "tokens=1,2 delims= " %%a in ('cmdkey /list ^| findstr "SERVICE"') do (
        echo Eliminando: %%b
        cmdkey /delete:%%b
    )
) else if "%tipo%"=="3" (
    echo ‚ö†Ô∏è ¬øEliminar TODAS las credenciales?
    set /p confirm="(S/N): "
    if /i "%confirm%"=="S" (
        echo üîÑ Limpiando todas las credenciales...
        for /f "tokens=1,2 delims= " %%a in ('cmdkey /list') do (
            cmdkey /delete:%%b
        )
    )
)
echo ‚úÖ Limpieza completada
pause
goto menu

:salir
exit
```

### Script para Recuperaci√≥n de Emergencia de Credenciales

```batch
@echo off
:: Recuperaci√≥n de emergencia de credenciales
title üö® Recuperaci√≥n de Credenciales
color 0C

echo ========================================
echo    üö® RECUPERACI√ìN DE CREDENCIALES
echo ========================================
echo.

:menu
echo 1. üîç Escaneo de emergencia
echo 2. üîë Recuperar credenciales cr√≠ticas
echo 3. üìã Generar reporte de emergencia
echo 4. üö™ Salir
echo.
set /p opcion="Selecciona opci√≥n: "

if "%opcion%"=="1" goto escaneo_emergencia
if "%opcion%"=="2" goto recuperar_criticas
if "%opcion%"=="3" goto reporte_emergencia
if "%opcion%"=="4" goto salir
goto menu

:escaneo_emergencia
cls
echo ========================================
echo         üîç ESCANEO DE EMERGENCIA
echo ========================================
echo.
echo üîç Escaneando credenciales cr√≠ticas...
echo.
echo === CREDENCIALES DE ADMINISTRACI√ìN ===
cmdkey /list | findstr /i "admin\|administrator"
echo.
echo === CREDENCIALES DE DOMINIO ===
cmdkey /list | findstr /i "domain\|corp"
echo.
echo === CREDENCIALES DE SERVIDORES ===
cmdkey /list | findstr /i "server\|srv"
echo.
echo === CREDENCIALES DE SERVICIOS ===
cmdkey /list | findstr /i "service\|system"
pause
goto menu

:recuperar_criticas
cls
echo ========================================
echo         üîë RECUPERAR CR√çTICAS
echo ========================================
echo.
echo üîÑ Recuperando credenciales cr√≠ticas...
echo.
echo === CREDENCIALES DE ADMINISTRACI√ìN ===
for /f "tokens=1,2 delims= " %%a in ('cmdkey /list ^| findstr "admin"') do (
    echo Credencial encontrada: %%b
    echo Usuario: %%a
)
echo.
echo === CREDENCIALES DE DOMINIO ===
for /f "tokens=1,2 delims= " %%a in ('cmdkey /list ^| findstr "domain"') do (
    echo Credencial encontrada: %%b
    echo Usuario: %%a
)
pause
goto menu

:reporte_emergencia
cls
echo ========================================
echo         üìã REPORTE DE EMERGENCIA
echo ========================================
echo.
echo üîÑ Generando reporte de emergencia...
set archivo=emergencia_credenciales_%date:~-4,4%%date:~-10,2%%date:~-7,2%_%time:~0,2%%time:~3,2%.txt
echo === REPORTE DE EMERGENCIA === > %archivo%
echo Fecha: %date% %time% >> %archivo%
echo. >> %archivo%
echo === CREDENCIALES CR√çTICAS === >> %archivo%
cmdkey /list >> %archivo%
echo. >> %archivo%
echo === AN√ÅLISIS DE SEGURIDAD === >> %archivo%
echo Credenciales de administraci√≥n: >> %archivo%
cmdkey /list | findstr /i "admin" >> %archivo%
echo ‚úÖ Reporte generado en %archivo%
pause
goto menu

:salir
exit
```

## Consejos Importantes

### ‚ö° **Optimizaci√≥n**
- Revisa regularmente las credenciales almacenadas
- Elimina credenciales obsoletas o expiradas
- Mant√©n un inventario actualizado de credenciales

### üõ°Ô∏è **Seguridad**
- Usa credenciales fuertes y √∫nicas
- Implementa rotaci√≥n regular de contrase√±as
- Documenta cambios en credenciales cr√≠ticas

### üîß **Mejores Pr√°cticas**
- Usa cmdkey para gesti√≥n program√°tica de credenciales
- Implementa auditor√≠as regulares de credenciales
- Mant√©n backups de configuraci√≥n de credenciales

## Casos de Uso Reales

### üè¢ **Administraci√≥n de Sistemas**
- Gesti√≥n de credenciales de servidores
- Automatizaci√≥n de scripts con autenticaci√≥n
- Recuperaci√≥n de credenciales perdidas

### üè´ **Entornos Educativos**
- Gesti√≥n de credenciales de laboratorios
- Configuraci√≥n de acceso a recursos educativos
- Auditor√≠a de credenciales de estudiantes

### üè≠ **Entornos Empresariales**
- Gesti√≥n de credenciales corporativas
- Cumplimiento de pol√≠ticas de seguridad
- Recuperaci√≥n ante incidentes

## Conclusi√≥n y Siguiente Paso

Has aprendido a gestionar credenciales guardadas de manera profesional y segura. Ahora puedes recuperar, administrar y auditar las contrase√±as almacenadas en el sistema Windows de manera eficiente.

En el siguiente cap√≠tulo, exploraremos c√≥mo **Crear red hospedada**, donde aprender√°s a configurar y gestionar redes virtuales desde la l√≠nea de comandos. ¬øTe imaginas creando redes de prueba para desarrollo o configurando entornos de aislamiento para seguridad? ¬°Esa ser√° tu pr√≥xima habilidad!

---

## Enlaces Relacionados

- [Cap√≠tulo 35: Conexiones de red](35.%20Conexiones%20de%20red.md)
- [Cap√≠tulo 37: Crear red hospedada](37.%20Crear%20red%20hospedada.md)
- [Cap√≠tulo 40: Ejecutar como Administrador - RUNAS](40.%20Ejecutar%20como%20Administrador%20-%20RUNAS.md)

## Fuentes y Referencias

- **Documentaci√≥n oficial de Microsoft:** [Cmdkey Command](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmdkey)
- **Windows Command Line Reference:** [Credential Management](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands)
- **Administraci√≥n de Windows Server:** [Credential Management](https://docs.microsoft.com/en-us/windows-server/administration/)

---

**Autor:** Jerson Mart√≠nez  
**Sitio web:** [jersonmartinez.com](https://jersonmartinez.com)  
**Blog DevOps:** [crashell.com](https://crashell.com) 