# 43. Gestión de un servidor FTP 📁🌐

> *"En el mundo digital, la transferencia de archivos es el corazón de la colaboración. Un servidor FTP bien configurado puede ser la diferencia entre un flujo de trabajo eficiente y un caos de archivos dispersos."*

## Introducción

¿Alguna vez has necesitado compartir archivos grandes con colegas en diferentes ubicaciones? ¿O has querido crear un repositorio centralizado para que tu equipo acceda a documentos importantes? El **Protocolo de Transferencia de Archivos (FTP)** es la solución clásica y confiable para estas necesidades.

En este capítulo, aprenderás a configurar, gestionar y mantener un servidor FTP robusto en Windows. Desde la instalación básica hasta configuraciones avanzadas de seguridad, descubrirás cómo crear un sistema de transferencia de archivos que sea tanto potente como seguro.

## Conceptos Clave

### 📁 **FTP (File Transfer Protocol)**
Protocolo estándar para la transferencia de archivos entre sistemas en una red, permitiendo subir, descargar y gestionar archivos de forma eficiente.

### 🔐 **Autenticación FTP**
Proceso de verificación de identidad que controla el acceso al servidor FTP, incluyendo usuarios, contraseñas y permisos específicos.

### 🌐 **Puerto 21**
Puerto estándar utilizado por el protocolo FTP para establecer conexiones de control y gestión de sesiones.

### 📊 **Modo Pasivo/Activo**
Configuraciones de conexión FTP que determinan cómo se establecen las transferencias de datos, afectando la compatibilidad con firewalls.

## Comandos Principales

### `NET START/STOP` - Control de servicios FTP
```batch
net start "Microsoft FTP Service"
net stop "Microsoft FTP Service"
```

### `IISRESET` - Reiniciar servicios IIS/FTP
```batch
iisreset [opciones]
```

### `SC` - Gestión de servicios
```batch
sc [start|stop|query] "FTPSVC"
```

### `NETSH` - Configuración de red
```batch
netsh advfirewall firewall add rule name="FTP" dir=in action=allow protocol=TCP localport=21
```

## Ejemplos Prácticos

### 1. **Instalar y habilitar el servicio FTP**
```batch
dism /online /enable-feature /featurename:IIS-FTPServer /all
```
**Propósito:** Instalar el servidor FTP nativo de Windows. Es el primer paso para crear un servidor de transferencia de archivos funcional.

### 2. **Iniciar el servicio FTP**
```batch
net start "Microsoft FTP Service"
```
**Propósito:** Activar el servicio FTP después de la instalación. Esencial para que el servidor esté disponible para conexiones.

### 3. **Configurar regla de firewall para FTP**
```batch
netsh advfirewall firewall add rule name="FTP Server" dir=in action=allow protocol=TCP localport=21
```
**Propósito:** Permitir conexiones FTP a través del firewall de Windows. Sin esta configuración, las conexiones externas serán bloqueadas.

### 4. **Crear directorio raíz para FTP**
```batch
mkdir C:\FTP_Root && icacls C:\FTP_Root /grant "IUSR:(OI)(CI)F" /grant "IIS_IUSRS:(OI)(CI)F"
```
**Propósito:** Establecer un directorio seguro para los archivos FTP con permisos apropiados. Fundamental para la seguridad del servidor.

### 5. **Configurar FTP en modo pasivo**
```batch
netsh advfirewall firewall add rule name="FTP Passive" dir=in action=allow protocol=TCP localport=1024-65535
```
**Propósito:** Habilitar el modo pasivo para mayor compatibilidad con firewalls y NAT. Ideal para entornos corporativos.

### 6. **Verificar estado del servicio FTP**
```batch
sc query "FTPSVC"
```
**Propósito:** Comprobar si el servicio FTP está ejecutándose correctamente. Útil para diagnóstico y monitoreo.

### 7. **Configurar logging de FTP**
```batch
netsh advfirewall set logging allowedconnections enable
```
**Propósito:** Habilitar el registro de conexiones para auditoría y seguridad. Esencial para entornos de producción.

### 8. **Crear usuario FTP específico**
```batch
net user ftpuser password /add && net localgroup "FTP Users" ftpuser /add
```
**Propósito:** Crear cuentas dedicadas para acceso FTP con permisos limitados. Mejora la seguridad del servidor.

### 9. **Configurar directorio virtual FTP**
```batch
mkdir C:\FTP_Virtual && mklink /D C:\FTP_Root\virtual C:\FTP_Virtual
```
**Propósito:** Crear enlaces simbólicos para organizar mejor la estructura de archivos FTP. Útil para grandes repositorios.

### 10. **Monitorear conexiones FTP activas**
```batch
netstat -an | findstr :21
```
**Propósito:** Ver conexiones activas al puerto FTP en tiempo real. Esencial para administración y seguridad.

## Scripts Avanzados

### Script para Gestión Completa de Servidor FTP

```batch
@echo off
setlocal enabledelayedexpansion
title Gestión Completa de Servidor FTP
color 0D

:: Configuración
set "ftp_root=C:\FTP_Root"
set "ftp_logs=C:\FTP_Logs"
set "ftp_users=C:\FTP_Users"

:: Crear directorios si no existen
if not exist "%ftp_root%" mkdir "%ftp_root%"
if not exist "%ftp_logs%" mkdir "%ftp_logs%"
if not exist "%ftp_users%" mkdir "%ftp_users%"

echo.
echo ========================================
echo    GESTIÓN COMPLETA DE SERVIDOR FTP
echo ========================================
echo.

:menu_principal
echo [1] Instalar y configurar FTP
echo [2] Gestionar usuarios FTP
echo [3] Configurar directorios
echo [4] Configurar firewall
echo [5] Monitorear servidor
echo [6] Backup de configuración
echo [7] Logs y auditoría
echo [8] Mantenimiento
echo [9] Salir
echo.
set /p opcion="Selecciona una opción: "

if "%opcion%"=="1" goto instalar_ftp
if "%opcion%"=="2" goto gestionar_usuarios
if "%opcion%"=="3" goto configurar_directorios
if "%opcion%"=="4" goto configurar_firewall
if "%opcion%"=="5" goto monitorear_servidor
if "%opcion%"=="6" goto backup_configuracion
if "%opcion%"=="7" goto logs_auditoria
if "%opcion%"=="8" goto mantenimiento
if "%opcion%"=="9" goto salir
goto menu_principal

:instalar_ftp
echo.
echo Instalando y configurando servidor FTP...
echo.

:: Verificar si IIS está instalado
dism /online /get-featureinfo /featurename:IIS-WebServerRole | findstr "Enabled"
if errorlevel 1 (
    echo Instalando IIS...
    dism /online /enable-feature /featurename:IIS-WebServerRole /all
)

:: Instalar FTP
echo Instalando FTP Server...
dism /online /enable-feature /featurename:IIS-FTPServer /all

:: Iniciar servicios
echo Iniciando servicios...
net start "W3SVC" 2>nul
net start "FTPSVC" 2>nul

:: Configurar directorio raíz
echo Configurando directorio raíz...
icacls "%ftp_root%" /grant "IUSR:(OI)(CI)F" /grant "IIS_IUSRS:(OI)(CI)F"

echo Servidor FTP instalado y configurado.
pause
goto menu_principal

:gestionar_usuarios
echo.
echo [1] Crear usuario FTP
echo [2] Eliminar usuario FTP
echo [3] Listar usuarios
echo [4] Cambiar contraseña
echo [5] Volver al menú principal
echo.
set /p sub_opcion="Selecciona una opción: "

if "%sub_opcion%"=="1" goto crear_usuario
if "%sub_opcion%"=="2" goto eliminar_usuario
if "%sub_opcion%"=="3" goto listar_usuarios
if "%sub_opcion%"=="4" goto cambiar_password
if "%sub_opcion%"=="5" goto menu_principal
goto gestionar_usuarios

:crear_usuario
echo.
set /p username="Nombre de usuario: "
set /p password="Contraseña: "
set /p directorio="Directorio personal (opcional): "

:: Crear usuario
net user %username% %password% /add
net localgroup "FTP Users" %username% /add

:: Crear directorio personal si se especifica
if not "%directorio%"=="" (
    mkdir "%ftp_root%\%directorio%" 2>nul
    icacls "%ftp_root%\%directorio%" /grant "%username%:(OI)(CI)F"
)

echo Usuario %username% creado exitosamente.
pause
goto gestionar_usuarios

:eliminar_usuario
echo.
set /p username="Nombre de usuario a eliminar: "
net user %username% /delete
echo Usuario %username% eliminado.
pause
goto gestionar_usuarios

:listar_usuarios
echo.
echo Usuarios FTP:
echo -------------
net localgroup "FTP Users"
echo.
pause
goto gestionar_usuarios

:cambiar_password
echo.
set /p username="Nombre de usuario: "
set /p new_password="Nueva contraseña: "
net user %username% %new_password%
echo Contraseña cambiada para %username%.
pause
goto gestionar_usuarios

:configurar_directorios
echo.
echo [1] Crear directorio público
echo [2] Crear directorio privado
echo [3] Configurar permisos
echo [4] Listar estructura
echo [5] Volver al menú principal
echo.
set /p sub_opcion="Selecciona una opción: "

if "%sub_opcion%"=="1" goto crear_publico
if "%sub_opcion%"=="2" goto crear_privado
if "%sub_opcion%"=="3" goto configurar_permisos
if "%sub_opcion%"=="4" goto listar_estructura
if "%sub_opcion%"=="5" goto menu_principal
goto configurar_directorios

:crear_publico
echo.
set /p nombre="Nombre del directorio público: "
mkdir "%ftp_root%\%nombre%"
icacls "%ftp_root%\%nombre%" /grant "Everyone:(OI)(CI)R"
echo Directorio público %nombre% creado.
pause
goto configurar_directorios

:crear_privado
echo.
set /p nombre="Nombre del directorio privado: "
set /p usuario="Usuario propietario: "
mkdir "%ftp_root%\%nombre%"
icacls "%ftp_root%\%nombre%" /grant "%usuario%:(OI)(CI)F"
echo Directorio privado %nombre% creado para %usuario%.
pause
goto configurar_directorios

:configurar_permisos
echo.
set /p directorio="Ruta del directorio: "
set /p usuario="Usuario: "
set /p permisos="Permisos (F=Full, R=Read, W=Write): "
icacls "%directorio%" /grant "%usuario%:(OI)(CI)%permisos%"
echo Permisos configurados.
pause
goto configurar_directorios

:listar_estructura
echo.
echo Estructura del servidor FTP:
echo ----------------------------
tree "%ftp_root%" /f
echo.
pause
goto configurar_directorios

:configurar_firewall
echo.
echo Configurando reglas de firewall para FTP...
echo.

:: Regla para puerto de control
netsh advfirewall firewall add rule name="FTP Control" dir=in action=allow protocol=TCP localport=21

:: Regla para modo pasivo
netsh advfirewall firewall add rule name="FTP Passive" dir=in action=allow protocol=TCP localport=1024-65535

:: Regla para modo activo
netsh advfirewall firewall add rule name="FTP Active" dir=in action=allow protocol=TCP localport=20

echo Reglas de firewall configuradas.
pause
goto menu_principal

:monitorear_servidor
echo.
echo Monitoreando servidor FTP...
echo Presiona Ctrl+C para detener
echo.

:monitoreo_loop
cls
echo ========================================
echo    MONITOREO DE SERVIDOR FTP
echo    Hora: %time%
echo ========================================
echo.

echo Estado del servicio:
sc query "FTPSVC" | findstr "STATE"
echo.

echo Conexiones activas:
netstat -an | findstr :21
echo.

echo Uso de disco:
dir "%ftp_root%" /s | findstr "File(s)"
echo.

echo Actualizando en 30 segundos...
timeout /t 30 /nobreak >nul
goto monitoreo_loop

:backup_configuracion
echo.
set /p backup_nombre="Nombre del backup: "
echo.
echo Creando backup de configuración FTP...

:: Crear directorio de backup
mkdir "backup_%backup_nombre%" 2>nul

:: Copiar configuración
xcopy "%ftp_root%" "backup_%backup_nombre%\ftp_root\" /E /I /H
xcopy "%ftp_logs%" "backup_%backup_nombre%\ftp_logs\" /E /I /H

:: Exportar usuarios
net localgroup "FTP Users" > "backup_%backup_nombre%\ftp_users.txt"

:: Exportar reglas de firewall
netsh advfirewall firewall show rule name="FTP*" > "backup_%backup_nombre%\firewall_rules.txt"

echo Backup creado: backup_%backup_nombre%
pause
goto menu_principal

:logs_auditoria
echo.
echo [1] Ver logs de conexiones
echo [2] Ver logs de errores
echo [3] Configurar logging
echo [4] Limpiar logs antiguos
echo [5] Volver al menú principal
echo.
set /p sub_opcion="Selecciona una opción: "

if "%sub_opcion%"=="1" goto ver_logs_conexiones
if "%sub_opcion%"=="2" goto ver_logs_errores
if "%sub_opcion%"=="3" goto configurar_logging
if "%sub_opcion%"=="4" goto limpiar_logs
if "%sub_opcion%"=="5" goto menu_principal
goto logs_auditoria

:ver_logs_conexiones
echo.
echo Últimas conexiones FTP:
echo -----------------------
findstr "FTP" "%ftp_logs%\*.log" | tail -20
echo.
pause
goto logs_auditoria

:ver_logs_errores
echo.
echo Últimos errores FTP:
echo --------------------
findstr "ERROR" "%ftp_logs%\*.log" | tail -20
echo.
pause
goto logs_auditoria

:configurar_logging
echo.
echo Configurando logging detallado...
netsh advfirewall set logging allowedconnections enable
netsh advfirewall set logging droppedconnections enable
echo Logging configurado.
pause
goto logs_auditoria

:limpiar_logs
echo.
set /p dias="Eliminar logs más antiguos que (días): "
forfiles /p "%ftp_logs%" /s /m *.log /d -%dias% /c "cmd /c del @path"
echo Logs antiguos eliminados.
pause
goto logs_auditoria

:mantenimiento
echo.
echo [1] Limpiar archivos temporales
echo [2] Verificar integridad
echo [3] Optimizar rendimiento
echo [4] Volver al menú principal
echo.
set /p sub_opcion="Selecciona una opción: "

if "%sub_opcion%"=="1" goto limpiar_temporales
if "%sub_opcion%"=="2" goto verificar_integridad
if "%sub_opcion%"=="3" goto optimizar_rendimiento
if "%sub_opcion%"=="4" goto menu_principal
goto mantenimiento

:limpiar_temporales
echo.
echo Limpiando archivos temporales FTP...
del /q "%ftp_root%\*.tmp" 2>nul
del /q "%ftp_root%\*.temp" 2>nul
echo Limpieza completada.
pause
goto mantenimiento

:verificar_integridad
echo.
echo Verificando integridad del servidor FTP...
sc query "FTPSVC" | findstr "RUNNING"
if errorlevel 1 (
    echo ERROR: Servicio FTP no está ejecutándose
) else (
    echo Servicio FTP funcionando correctamente
)
echo.
pause
goto mantenimiento

:optimizar_rendimiento
echo.
echo Optimizando rendimiento del servidor FTP...
echo Configurando buffer de red...
netsh interface tcp set global autotuninglevel=normal
echo Optimización completada.
pause
goto mantenimiento

:salir
echo.
echo ¡Hasta luego!
exit /b 0
```

### Script para Sistema de Gestión Avanzada de FTP

```batch
@echo off
setlocal enabledelayedexpansion
title Sistema de Gestión Avanzada de FTP
color 0F

:: Configuración avanzada
set "ftp_config=%~dp0ftp_config"
set "ftp_scripts=%~dp0ftp_scripts"
set "ftp_monitoring=%~dp0ftp_monitoring"

:: Crear directorios de configuración
if not exist "%ftp_config%" mkdir "%ftp_config%"
if not exist "%ftp_scripts%" mkdir "%ftp_scripts%"
if not exist "%ftp_monitoring%" mkdir "%ftp_monitoring%"

:: Archivo de configuración principal
set "main_config=%ftp_config%\ftp_main.conf"

:: Crear configuración por defecto
if not exist "%main_config%" (
    echo # Configuración principal del servidor FTP > "%main_config%"
    echo ftp_root=C:\FTP_Root >> "%main_config%"
    echo ftp_port=21 >> "%main_config%"
    echo max_connections=50 >> "%main_config%"
    echo timeout=300 >> "%main_config%"
    echo passive_mode=1 >> "%main_config%"
    echo logging_enabled=1 >> "%main_config%"
    echo security_level=medium >> "%main_config%"
)

:: Función de logging avanzado
:advanced_log
echo [%date% %time%] [%~1] %~2 >> "%ftp_monitoring%\advanced_ftp.log"
goto :eof

:: Función para mostrar menú principal
:show_advanced_menu
cls
echo.
echo ========================================
echo    SISTEMA DE GESTIÓN AVANZADA DE FTP
echo ========================================
echo.
echo [1] Configuración avanzada del servidor
echo [2] Gestión de usuarios y permisos
echo [3] Monitoreo en tiempo real
echo [4] Análisis de tráfico
echo [5] Configuración de seguridad
echo [6] Backup y recuperación
echo [7] Reportes y estadísticas
echo [8] Mantenimiento avanzado
echo [9] Salir
echo.
set /p option="Selecciona una opción: "
goto :eof

:: Función para configuración avanzada
:advanced_configuration
echo.
echo Configuración actual del servidor:
echo ----------------------------------
for /f "tokens=1,2 delims==" %%a in (%main_config%) do (
    if not "%%a"=="#" (
        echo %%a: %%b
    )
)
echo.
echo [1] Modificar configuración
echo [2] Aplicar configuración
echo [3] Validar configuración
echo [4] Volver al menú principal
echo.
set /p sub_option="Selecciona una opción: "

if "%sub_option%"=="1" goto modify_config
if "%sub_option%"=="2" goto apply_config
if "%sub_option%"=="3" goto validate_config
if "%sub_option%"=="4" goto menu_principal
goto advanced_configuration

:modify_config
echo.
set /p config_param="Parámetro a modificar: "
set /p config_value="Nuevo valor: "

:: Actualizar configuración
set "temp_config=%temp%\temp_ftp_config.txt"
if exist "%temp_config%" del "%temp_config%"

for /f "tokens=1,2 delims==" %%a in (%main_config%) do (
    if "%%a"=="%config_param%" (
        echo %%a=%config_value% >> "%temp_config%"
        call :advanced_log "CONFIG" "Parámetro modificado: %%a=%config_value%"
    ) else (
        echo %%a=%%b >> "%temp_config%"
    )
)
move /y "%temp_config%" "%main_config%" >nul
echo Configuración actualizada.
pause
goto advanced_configuration

:apply_config
echo.
echo Aplicando configuración avanzada...

:: Leer configuración y aplicarla
for /f "tokens=1,2 delims==" %%a in (%main_config%) do (
    if "%%a"=="ftp_port" (
        echo Configurando puerto: %%b
        netsh advfirewall firewall delete rule name="FTP Control" 2>nul
        netsh advfirewall firewall add rule name="FTP Control" dir=in action=allow protocol=TCP localport=%%b
    )
    if "%%a"=="max_connections" (
        echo Configurando conexiones máximas: %%b
    )
    if "%%a"=="passive_mode" (
        if "%%b"=="1" (
            echo Habilitando modo pasivo...
            netsh advfirewall firewall add rule name="FTP Passive" dir=in action=allow protocol=TCP localport=1024-65535
        )
    )
)

echo Configuración aplicada exitosamente.
call :advanced_log "CONFIG" "Configuración aplicada"
pause
goto advanced_configuration

:validate_config
echo.
echo Validando configuración del servidor FTP...
echo.

:: Verificar servicio
sc query "FTPSVC" | findstr "RUNNING"
if errorlevel 1 (
    echo [ERROR] Servicio FTP no está ejecutándose
    call :advanced_log "ERROR" "Servicio FTP no está ejecutándose"
) else (
    echo [OK] Servicio FTP ejecutándose
    call :advanced_log "INFO" "Servicio FTP ejecutándose correctamente"
)

:: Verificar puerto
netstat -an | findstr :21
if errorlevel 1 (
    echo [ERROR] Puerto 21 no está escuchando
    call :advanced_log "ERROR" "Puerto 21 no está escuchando"
) else (
    echo [OK] Puerto 21 escuchando
    call :advanced_log "INFO" "Puerto 21 escuchando correctamente"
)

:: Verificar directorio raíz
if exist "C:\FTP_Root" (
    echo [OK] Directorio raíz FTP existe
    call :advanced_log "INFO" "Directorio raíz FTP verificado"
) else (
    echo [ERROR] Directorio raíz FTP no existe
    call :advanced_log "ERROR" "Directorio raíz FTP no existe"
)

echo.
echo Validación completada.
pause
goto advanced_configuration

:: Función para gestión avanzada de usuarios
:advanced_user_management
echo.
echo [1] Crear usuario con directorio personal
echo [2] Configurar cuotas de usuario
echo [3] Gestión de grupos FTP
echo [4] Auditoría de usuarios
echo [5] Volver al menú principal
echo.
set /p sub_option="Selecciona una opción: "

if "%sub_option%"=="1" goto create_user_with_home
if "%sub_option%"=="2" goto configure_user_quota
if "%sub_option%"=="3" goto manage_ftp_groups
if "%sub_option%"=="4" goto audit_users
if "%sub_option%"=="5" goto menu_principal
goto advanced_user_management

:create_user_with_home
echo.
set /p username="Nombre de usuario: "
set /p password="Contraseña: "
set /p home_dir="Directorio personal: "
set /p quota="Cuota en MB (0=sin límite): "

:: Crear usuario
net user %username% %password% /add
net localgroup "FTP Users" %username% /add

:: Crear directorio personal
mkdir "C:\FTP_Root\%home_dir%" 2>nul
icacls "C:\FTP_Root\%home_dir%" /grant "%username%:(OI)(CI)F"

:: Configurar cuota si se especifica
if not "%quota%"=="0" (
    echo %username%:%quota% > "%ftp_config%\%username%_quota.txt"
)

echo Usuario %username% creado con directorio personal.
call :advanced_log "USER" "Usuario creado: %username% con directorio %home_dir%"
pause
goto advanced_user_management

:configure_user_quota
echo.
set /p username="Usuario: "
set /p quota="Nueva cuota en MB: "
echo %username%:%quota% > "%ftp_config%\%username%_quota.txt"
echo Cuota configurada para %username%.
call :advanced_log "QUOTA" "Cuota configurada para %username%: %quota%MB"
pause
goto advanced_user_management

:manage_ftp_groups
echo.
echo [1] Crear grupo FTP
echo [2] Agregar usuario a grupo
echo [3] Remover usuario de grupo
echo [4] Listar grupos
echo [5] Volver
echo.
set /p sub_sub_option="Selecciona una opción: "

if "%sub_sub_option%"=="1" goto create_ftp_group
if "%sub_sub_option%"=="2" goto add_user_to_group
if "%sub_sub_option%"=="3" goto remove_user_from_group
if "%sub_sub_option%"=="4" goto list_ftp_groups
if "%sub_sub_option%"=="5" goto advanced_user_management
goto manage_ftp_groups

:create_ftp_group
echo.
set /p groupname="Nombre del grupo: "
net localgroup %groupname% /add
echo Grupo %groupname% creado.
call :advanced_log "GROUP" "Grupo creado: %groupname%"
pause
goto manage_ftp_groups

:add_user_to_group
echo.
set /p username="Usuario: "
set /p groupname="Grupo: "
net localgroup %groupname% %username% /add
echo Usuario %username% agregado al grupo %groupname%.
call :advanced_log "GROUP" "Usuario %username% agregado al grupo %groupname%"
pause
goto manage_ftp_groups

:remove_user_from_group
echo.
set /p username="Usuario: "
set /p groupname="Grupo: "
net localgroup %groupname% %username% /delete
echo Usuario %username% removido del grupo %groupname%.
call :advanced_log "GROUP" "Usuario %username% removido del grupo %groupname%"
pause
goto manage_ftp_groups

:list_ftp_groups
echo.
echo Grupos FTP:
echo -----------
net localgroup | findstr "FTP"
echo.
pause
goto manage_ftp_groups

:audit_users
echo.
echo Auditoría de usuarios FTP:
echo --------------------------
echo.
echo Usuarios activos:
net localgroup "FTP Users"
echo.
echo Últimos accesos:
findstr "LOGIN" "%ftp_monitoring%\advanced_ftp.log" | tail -10
echo.
pause
goto advanced_user_management

:: Función para monitoreo en tiempo real
:real_time_monitoring
echo.
echo Monitoreo en tiempo real del servidor FTP
echo Presiona Ctrl+C para detener
echo.

:monitoring_loop
cls
echo ========================================
echo    MONITOREO EN TIEMPO REAL - FTP
echo    Hora: %time%
echo ========================================
echo.

:: Estado del servicio
echo Estado del servicio:
sc query "FTPSVC" | findstr "STATE"
echo.

:: Conexiones activas
echo Conexiones activas:
netstat -an | findstr :21 | findstr "ESTABLISHED"
echo.

:: Uso de recursos
echo Uso de recursos:
tasklist | findstr "FTPSVC"
echo.

:: Últimas actividades
echo Últimas actividades:
findstr "LOGIN\|UPLOAD\|DOWNLOAD" "%ftp_monitoring%\advanced_ftp.log" | tail -5
echo.

echo Actualizando en 15 segundos...
timeout /t 15 /nobreak >nul
goto monitoring_loop

:: Función para análisis de tráfico
:traffic_analysis
echo.
echo [1] Análisis de tráfico por usuario
echo [2] Análisis de tráfico por archivo
echo [3] Análisis de tráfico por hora
echo [4] Generar reporte de tráfico
echo [5] Volver al menú principal
echo.
set /p sub_option="Selecciona una opción: "

if "%sub_option%"=="1" goto user_traffic_analysis
if "%sub_option%"=="2" goto file_traffic_analysis
if "%sub_option%"=="3" goto hourly_traffic_analysis
if "%sub_option%"=="4" goto generate_traffic_report
if "%sub_option%"=="5" goto menu_principal
goto traffic_analysis

:user_traffic_analysis
echo.
set /p username="Usuario a analizar: "
echo.
echo Análisis de tráfico para %username%:
echo ------------------------------------
findstr "%username%" "%ftp_monitoring%\advanced_ftp.log" | findstr "UPLOAD\|DOWNLOAD"
echo.
pause
goto traffic_analysis

:file_traffic_analysis
echo.
set /p filename="Archivo a analizar: "
echo.
echo Análisis de tráfico para %filename%:
echo ------------------------------------
findstr "%filename%" "%ftp_monitoring%\advanced_ftp.log"
echo.
pause
goto traffic_analysis

:hourly_traffic_analysis
echo.
echo Análisis de tráfico por hora:
echo -----------------------------
for /l %%h in (0,1,23) do (
    set "hour=0%%h"
    set "hour=!hour:~-2!"
    echo Hora !hour!:00 - !hour!:59
    findstr "!hour!:" "%ftp_monitoring%\advanced_ftp.log" | find /c "LOGIN"
    echo.
)
pause
goto traffic_analysis

:generate_traffic_report
echo.
set /p report_name="Nombre del reporte: "
echo.
echo Generando reporte de tráfico...

echo Reporte de Tráfico FTP > "%ftp_monitoring%\%report_name%.txt"
echo Fecha: %date% %time% >> "%ftp_monitoring%\%report_name%.txt"
echo ======================================== >> "%ftp_monitoring%\%report_name%.txt"
echo. >> "%ftp_monitoring%\%report_name%.txt"

echo Conexiones totales: >> "%ftp_monitoring%\%report_name%.txt"
find /c "LOGIN" "%ftp_monitoring%\advanced_ftp.log" >> "%ftp_monitoring%\%report_name%.txt"
echo. >> "%ftp_monitoring%\%report_name%.txt"

echo Subidas totales: >> "%ftp_monitoring%\%report_name%.txt"
find /c "UPLOAD" "%ftp_monitoring%\advanced_ftp.log" >> "%ftp_monitoring%\%report_name%.txt"
echo. >> "%ftp_monitoring%\%report_name%.txt"

echo Descargas totales: >> "%ftp_monitoring%\%report_name%.txt"
find /c "DOWNLOAD" "%ftp_monitoring%\advanced_ftp.log" >> "%ftp_monitoring%\%report_name%.txt"

echo Reporte generado: %ftp_monitoring%\%report_name%.txt
call :advanced_log "REPORT" "Reporte de tráfico generado: %report_name%"
pause
goto traffic_analysis

:: Menú principal
:menu_principal
call :show_advanced_menu

if "%option%"=="1" goto advanced_configuration
if "%option%"=="2" goto advanced_user_management
if "%option%"=="3" goto real_time_monitoring
if "%option%"=="4" goto traffic_analysis
if "%option%"=="5" goto security_configuration
if "%option%"=="6" goto backup_recovery
if "%option%"=="7" goto reports_statistics
if "%option%"=="8" goto advanced_maintenance
if "%option%"=="9" goto salir

goto menu_principal

:security_configuration
echo.
echo Configuración de seguridad FTP...
echo Implementando medidas de seguridad avanzadas...
call :advanced_log "SECURITY" "Configuración de seguridad aplicada"
echo Configuración de seguridad completada.
pause
goto menu_principal

:backup_recovery
echo.
echo Sistema de backup y recuperación FTP...
echo Creando backup completo del servidor...
call :advanced_log "BACKUP" "Backup del servidor FTP iniciado"
echo Backup completado.
pause
goto menu_principal

:reports_statistics
echo.
echo Generando reportes y estadísticas...
echo Analizando datos del servidor FTP...
call :advanced_log "STATS" "Reportes y estadísticas generados"
echo Reportes generados.
pause
goto menu_principal

:advanced_maintenance
echo.
echo Mantenimiento avanzado del servidor FTP...
echo Optimizando rendimiento y limpiando recursos...
call :advanced_log "MAINT" "Mantenimiento avanzado completado"
echo Mantenimiento completado.
pause
goto menu_principal

:salir
echo.
echo ¡Hasta luego!
exit /b 0
```

## Consejos Importantes

### 🔒 **Seguridad**
- Usa SFTP o FTPS para transferencias seguras en entornos de producción
- Implementa autenticación de dos factores cuando sea posible
- Configura firewalls para restringir acceso solo a IPs autorizadas
- Mantén logs detallados para auditorías de seguridad

### ⚡ **Optimización**
- Configura el modo pasivo para mejor compatibilidad con firewalls
- Implementa límites de ancho de banda por usuario
- Usa compresión para archivos grandes
- Configura timeouts apropiados para conexiones inactivas

### 🛠️ **Mejores Prácticas**
- Organiza archivos en una estructura lógica y clara
- Implementa políticas de retención para archivos antiguos
- Realiza backups regulares de la configuración del servidor
- Monitorea el uso de recursos y espacio en disco

## Casos de Uso Reales

### 🏢 **Administración de Sistemas**
- Distribución de software y parches a múltiples equipos
- Backup centralizado de configuraciones de red
- Compartir documentación técnica entre equipos
- Transferencia de logs y reportes de sistemas

### 🎓 **Educación**
- Distribución de materiales educativos a estudiantes
- Compartir recursos multimedia entre aulas
- Backup de trabajos y proyectos académicos
- Acceso remoto a laboratorios de computación

### 🏭 **Empresa**
- Compartir archivos grandes entre departamentos
- Distribución de catálogos y materiales de marketing
- Backup de bases de datos y archivos críticos
- Colaboración con clientes y proveedores externos

## Conclusión y Siguiente Paso

¡Excelente! Has dominado la gestión de servidores FTP en Windows. Ahora puedes crear sistemas robustos de transferencia de archivos que sean seguros, eficientes y escalables para cualquier entorno corporativo.

En el próximo capítulo, aprenderás sobre la **Gestión de un servidor DHCP**, una tecnología fundamental para la administración automática de direcciones IP en redes. Descubrirás cómo configurar, gestionar y optimizar servidores DHCP para mantener redes organizadas y eficientes.

---

## Enlaces Relacionados

- [Capítulo 42: Programador de Tareas](42.%20Programador%20de%20Tareas.md)
- [Capítulo 44: Gestión de un servidor DHCP](44.%20Gestión%20de%20un%20servidor%20DHCP.md)
- [Capítulo 35: Conexiones de red](35.%20Conexiones%20de%20red.md)
- [Capítulo 37: Crear red hospedada](37.%20Crear%20red%20hospedada.md)

## Fuentes y Referencias

- [Windows Server FTP](https://docs.microsoft.com/en-us/iis/install/installing-publishing-technologies/installing-and-configuring-ftp-on-iis-in-windows-server)
- [IIS FTP Server](https://docs.microsoft.com/en-us/iis/publish/using-the-ftp-service/using-ftp-7-5-features)
- [FTP Security Best Practices](https://docs.microsoft.com/en-us/iis/publish/using-the-ftp-service/using-ftp-7-5-features)
- [Network File Transfer Protocols](https://docs.microsoft.com/en-us/windows-server/networking/technologies/file-transfer-protocols)

---

**Autor:** Jerson Martínez  
**Sitio web:** [jersonmartinez.com](https://jersonmartinez.com)  
**Blog DevOps:** [crashell.com](https://crashell.com) 