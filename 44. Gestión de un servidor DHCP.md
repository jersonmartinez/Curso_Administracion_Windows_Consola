# 44. Gesti√≥n de un servidor DHCP üåêüîß

> *"En el mundo de las redes, el DHCP es el director de tr√°fico invisible que asigna direcciones IP autom√°ticamente, manteniendo el orden en el caos de dispositivos conectados."*

## Introducci√≥n

¬øTe imaginas tener que configurar manualmente la direcci√≥n IP de cada dispositivo en una red de 1000 equipos? ¬øO qu√© pasar√≠a si dos dispositivos tuvieran la misma direcci√≥n IP? El **Protocolo de Configuraci√≥n Din√°mica de Host (DHCP)** es la soluci√≥n elegante que hace que las redes funcionen de manera fluida y autom√°tica.

En este cap√≠tulo, aprender√°s a configurar, gestionar y optimizar un servidor DHCP en Windows. Desde la instalaci√≥n b√°sica hasta configuraciones avanzadas de reservas y pol√≠ticas, descubrir√°s c√≥mo crear un sistema de asignaci√≥n de direcciones IP que sea robusto, eficiente y escalable.

## Conceptos Clave

### üåê **DHCP (Dynamic Host Configuration Protocol)**
Protocolo que automatiza la asignaci√≥n de direcciones IP y configuraciones de red a dispositivos cliente, eliminando la necesidad de configuraci√≥n manual.

### üìã **Scope (√Åmbito)**
Rango de direcciones IP que el servidor DHCP puede asignar a los clientes, incluyendo configuraciones como m√°scara de subred y gateway.

### üîí **Reservation (Reserva)**
Asignaci√≥n permanente de una direcci√≥n IP espec√≠fica a un dispositivo basado en su direcci√≥n MAC, garantizando consistencia.

### ‚è∞ **Lease (Arrendamiento)**
Per√≠odo de tiempo durante el cual un cliente puede usar una direcci√≥n IP asignada antes de renovarla o liberarla.

## Comandos Principales

### `NETSH DHCP` - Gesti√≥n de servidor DHCP
```batch
netsh dhcp [opciones]
```

### `NETSH DHCP SERVER` - Configuraci√≥n del servidor
```batch
netsh dhcp server [opciones]
```

### `NETSH DHCP SERVER SCOPE` - Gesti√≥n de √°mbitos
```batch
netsh dhcp server scope [opciones]
```

### `NETSH DHCP SERVER RESERVATION` - Gesti√≥n de reservas
```batch
netsh dhcp server reservation [opciones]
```

## Ejemplos Pr√°cticos

### 1. **Instalar el rol de servidor DHCP**
```batch
dism /online /enable-feature /featurename:DHCPServer /all
```
**Prop√≥sito:** Instalar el servicio DHCP nativo de Windows Server. Es el primer paso para crear un servidor de asignaci√≥n autom√°tica de direcciones IP.

### 2. **Iniciar el servicio DHCP**
```batch
net start "DHCP Server"
```
**Prop√≥sito:** Activar el servicio DHCP despu√©s de la instalaci√≥n. Esencial para que el servidor comience a asignar direcciones IP a los clientes.

### 3. **Crear un √°mbito DHCP b√°sico**
```batch
netsh dhcp server scope 192.168.1.0 add name="Red Principal" start=192.168.1.100 end=192.168.1.200
```
**Prop√≥sito:** Definir un rango de direcciones IP que el servidor puede asignar. Fundamental para organizar la red y evitar conflictos.

### 4. **Configurar opciones del √°mbito**
```batch
netsh dhcp server scope 192.168.1.0 set optionvalue 3 IPADDRESS 192.168.1.1
```
**Prop√≥sito:** Establecer el gateway predeterminado para todos los clientes del √°mbito. Esencial para la conectividad de red.

### 5. **Crear una reserva de direcci√≥n IP**
```batch
netsh dhcp server scope 192.168.1.0 add reservedip 192.168.1.50 00-11-22-33-44-55 "Servidor Web"
```
**Prop√≥sito:** Asignar una direcci√≥n IP fija a un dispositivo espec√≠fico basado en su MAC. Ideal para servidores y dispositivos cr√≠ticos.

### 6. **Configurar servidores DNS**
```batch
netsh dhcp server scope 192.168.1.0 set optionvalue 6 IPADDRESS 8.8.8.8 8.8.4.4
```
**Prop√≥sito:** Proporcionar direcciones de servidores DNS a los clientes DHCP. Necesario para la resoluci√≥n de nombres de dominio.

### 7. **Verificar estado del servidor DHCP**
```batch
netsh dhcp server show all
```
**Prop√≥sito:** Comprobar la configuraci√≥n completa del servidor DHCP. √ötil para diagn√≥stico y auditor√≠a de configuraciones.

### 8. **Mostrar √°mbitos activos**
```batch
netsh dhcp server scope show state
```
**Prop√≥sito:** Ver todos los √°mbitos configurados y su estado actual. Esencial para administraci√≥n y monitoreo.

### 9. **Configurar tiempo de arrendamiento**
```batch
netsh dhcp server scope 192.168.1.0 set lease 86400
```
**Prop√≥sito:** Establecer el tiempo de arrendamiento en segundos (24 horas en este caso). Afecta la frecuencia de renovaciones.

### 10. **Excluir rangos de direcciones**
```batch
netsh dhcp server scope 192.168.1.0 add excluderange 192.168.1.1 192.168.1.10
```
**Prop√≥sito:** Reservar direcciones IP para uso manual o dispositivos est√°ticos. Previene conflictos con equipos con IP fija.

## Scripts Avanzados

### Script para Gesti√≥n Completa de Servidor DHCP

```batch
@echo off
setlocal enabledelayedexpansion
title Gesti√≥n Completa de Servidor DHCP
color 0B

:: Configuraci√≥n
set "dhcp_config=C:\DHCP_Config"
set "dhcp_logs=C:\DHCP_Logs"
set "dhcp_backup=C:\DHCP_Backup"

:: Crear directorios si no existen
if not exist "%dhcp_config%" mkdir "%dhcp_config%"
if not exist "%dhcp_logs%" mkdir "%dhcp_logs%"
if not exist "%dhcp_backup%" mkdir "%dhcp_backup%"

echo.
echo ========================================
echo    GESTI√ìN COMPLETA DE SERVIDOR DHCP
echo ========================================
echo.

:menu_principal
echo [1] Instalar y configurar DHCP
echo [2] Gestionar √°mbitos DHCP
echo [3] Gestionar reservas
echo [4] Configurar opciones
echo [5] Monitorear servidor
echo [6] Backup y restauraci√≥n
echo [7] Logs y auditor√≠a
echo [8] Mantenimiento
echo [9] Salir
echo.
set /p opcion="Selecciona una opci√≥n: "

if "%opcion%"=="1" goto instalar_dhcp
if "%opcion%"=="2" goto gestionar_ambitos
if "%opcion%"=="3" goto gestionar_reservas
if "%opcion%"=="4" goto configurar_opciones
if "%opcion%"=="5" goto monitorear_servidor
if "%opcion%"=="6" goto backup_restauracion
if "%opcion%"=="7" goto logs_auditoria
if "%opcion%"=="8" goto mantenimiento
if "%opcion%"=="9" goto salir
goto menu_principal

:instalar_dhcp
echo.
echo Instalando y configurando servidor DHCP...
echo.

:: Verificar si DHCP est√° instalado
dism /online /get-featureinfo /featurename:DHCPServer | findstr "Enabled"
if errorlevel 1 (
    echo Instalando DHCP Server...
    dism /online /enable-feature /featurename:DHCPServer /all
)

:: Iniciar servicio
echo Iniciando servicio DHCP...
net start "DHCP Server" 2>nul

:: Autorizar servidor DHCP
echo Autorizando servidor DHCP...
netsh dhcp server add securitygroups

echo Servidor DHCP instalado y configurado.
pause
goto menu_principal

:gestionar_ambitos
echo.
echo [1] Crear nuevo √°mbito
echo [2] Listar √°mbitos existentes
echo [3] Activar/Desactivar √°mbito
echo [4] Eliminar √°mbito
echo [5] Configurar exclusiones
echo [6] Volver al men√∫ principal
echo.
set /p sub_opcion="Selecciona una opci√≥n: "

if "%sub_opcion%"=="1" goto crear_ambito
if "%sub_opcion%"=="2" goto listar_ambitos
if "%sub_opcion%"=="3" goto activar_ambito
if "%sub_opcion%"=="4" goto eliminar_ambito
if "%sub_opcion%"=="5" goto configurar_exclusiones
if "%sub_opcion%"=="6" goto menu_principal
goto gestionar_ambitos

:crear_ambito
echo.
set /p red="Red (ej: 192.168.1.0): "
set /p nombre="Nombre del √°mbito: "
set /p inicio="IP inicial (ej: 192.168.1.100): "
set /p fin="IP final (ej: 192.168.1.200): "
set /p mascara="M√°scara de subred (ej: 255.255.255.0): "

:: Crear √°mbito
netsh dhcp server scope %red% add name="%nombre%" start=%inicio% end=%fin% mask=%mascara%

:: Activar √°mbito
netsh dhcp server scope %red% set state 1

echo √Åmbito %nombre% creado y activado.
pause
goto gestionar_ambitos

:listar_ambitos
echo.
echo √Åmbitos DHCP configurados:
echo ---------------------------
netsh dhcp server scope show state
echo.
pause
goto gestionar_ambitos

:activar_ambito
echo.
set /p red="Red del √°mbito: "
set /p estado="Estado (1=Activar, 0=Desactivar): "
netsh dhcp server scope %red% set state %estado%
echo Estado del √°mbito actualizado.
pause
goto gestionar_ambitos

:eliminar_ambito
echo.
set /p red="Red del √°mbito a eliminar: "
netsh dhcp server scope %red% delete
echo √Åmbito eliminado.
pause
goto gestionar_ambitos

:configurar_exclusiones
echo.
set /p red="Red del √°mbito: "
set /p inicio_excl="IP inicial de exclusi√≥n: "
set /p fin_excl="IP final de exclusi√≥n: "
netsh dhcp server scope %red% add excluderange %inicio_excl% %fin_excl%
echo Exclusi√≥n configurada.
pause
goto gestionar_ambitos

:gestionar_reservas
echo.
echo [1] Crear reserva
echo [2] Listar reservas
echo [3] Eliminar reserva
echo [4] Modificar reserva
echo [5] Volver al men√∫ principal
echo.
set /p sub_opcion="Selecciona una opci√≥n: "

if "%sub_opcion%"=="1" goto crear_reserva
if "%sub_opcion%"=="2" goto listar_reservas
if "%sub_opcion%"=="3" goto eliminar_reserva
if "%sub_opcion%"=="4" goto modificar_reserva
if "%sub_opcion%"=="5" goto menu_principal
goto gestionar_reservas

:crear_reserva
echo.
set /p red="Red del √°mbito: "
set /p ip="Direcci√≥n IP: "
set /p mac="Direcci√≥n MAC (formato: 00-11-22-33-44-55): "
set /p nombre="Nombre del dispositivo: "
netsh dhcp server scope %red% add reservedip %ip% %mac% "%nombre%"
echo Reserva creada para %nombre%.
pause
goto gestionar_reservas

:listar_reservas
echo.
set /p red="Red del √°mbito: "
echo Reservas en %red%:
echo ------------------
netsh dhcp server scope %red% show reservedip
echo.
pause
goto gestionar_reservas

:eliminar_reserva
echo.
set /p red="Red del √°mbito: "
set /p ip="Direcci√≥n IP de la reserva: "
netsh dhcp server scope %red% delete reservedip %ip%
echo Reserva eliminada.
pause
goto gestionar_reservas

:modificar_reserva
echo.
set /p red="Red del √°mbito: "
set /p ip="Direcci√≥n IP de la reserva: "
set /p nuevo_nombre="Nuevo nombre: "
netsh dhcp server scope %red% set reservedoptionvalue %ip% 12 STRING "%nuevo_nombre%"
echo Reserva modificada.
pause
goto gestionar_reservas

:configurar_opciones
echo.
echo [1] Configurar gateway
echo [2] Configurar DNS
echo [3] Configurar tiempo de arrendamiento
echo [4] Configurar WINS
echo [5] Ver opciones actuales
echo [6] Volver al men√∫ principal
echo.
set /p sub_opcion="Selecciona una opci√≥n: "

if "%sub_opcion%"=="1" goto configurar_gateway
if "%sub_opcion%"=="2" goto configurar_dns
if "%sub_opcion%"=="3" goto configurar_lease
if "%sub_opcion%"=="4" goto configurar_wins
if "%sub_opcion%"=="5" goto ver_opciones
if "%sub_opcion%"=="6" goto menu_principal
goto configurar_opciones

:configurar_gateway
echo.
set /p red="Red del √°mbito: "
set /p gateway="Gateway (ej: 192.168.1.1): "
netsh dhcp server scope %red% set optionvalue 3 IPADDRESS %gateway%
echo Gateway configurado.
pause
goto configurar_opciones

:configurar_dns
echo.
set /p red="Red del √°mbito: "
set /p dns1="DNS primario: "
set /p dns2="DNS secundario: "
netsh dhcp server scope %red% set optionvalue 6 IPADDRESS %dns1% %dns2%
echo Servidores DNS configurados.
pause
goto configurar_opciones

:configurar_lease
echo.
set /p red="Red del √°mbito: "
set /p tiempo="Tiempo de arrendamiento en segundos: "
netsh dhcp server scope %red% set lease %tiempo%
echo Tiempo de arrendamiento configurado.
pause
goto configurar_opciones

:configurar_wins
echo.
set /p red="Red del √°mbito: "
set /p wins="Servidor WINS: "
netsh dhcp server scope %red% set optionvalue 44 IPADDRESS %wins%
echo Servidor WINS configurado.
pause
goto configurar_opciones

:ver_opciones
echo.
set /p red="Red del √°mbito: "
echo Opciones configuradas en %red%:
echo --------------------------------
netsh dhcp server scope %red% show optionvalue
echo.
pause
goto configurar_opciones

:monitorear_servidor
echo.
echo Monitoreando servidor DHCP...
echo Presiona Ctrl+C para detener
echo.

:monitoreo_loop
cls
echo ========================================
echo    MONITOREO DE SERVIDOR DHCP
echo    Hora: %time%
echo ========================================
echo.

echo Estado del servicio:
sc query "DHCPServer" | findstr "STATE"
echo.

echo √Åmbitos activos:
netsh dhcp server scope show state | findstr "Active"
echo.

echo Estad√≠sticas de arrendamientos:
netsh dhcp server show mibinfo
echo.

echo Actualizando en 30 segundos...
timeout /t 30 /nobreak >nul
goto monitoreo_loop

:backup_restauracion
echo.
echo [1] Crear backup
echo [2] Restaurar backup
echo [3] Exportar configuraci√≥n
echo [4] Importar configuraci√≥n
echo [5] Volver al men√∫ principal
echo.
set /p sub_opcion="Selecciona una opci√≥n: "

if "%sub_opcion%"=="1" goto crear_backup
if "%sub_opcion%"=="2" goto restaurar_backup
if "%sub_opcion%"=="3" goto exportar_config
if "%sub_opcion%"=="4" goto importar_config
if "%sub_opcion%"=="5" goto menu_principal
goto backup_restauracion

:crear_backup
echo.
set /p backup_nombre="Nombre del backup: "
echo.
echo Creando backup del servidor DHCP...

:: Exportar configuraci√≥n
netsh dhcp server export "%dhcp_backup%\%backup_nombre%.xml" all

:: Backup de logs
xcopy "%dhcp_logs%" "%dhcp_backup%\%backup_nombre%_logs\" /E /I /H

echo Backup creado: %dhcp_backup%\%backup_nombre%.xml
pause
goto backup_restauracion

:restaurar_backup
echo.
set /p backup_archivo="Archivo de backup a restaurar: "
echo.
echo Restaurando configuraci√≥n DHCP...
netsh dhcp server import "%backup_archivo%"
echo Restauraci√≥n completada.
pause
goto backup_restauracion

:exportar_config
echo.
set /p archivo="Nombre del archivo de exportaci√≥n: "
echo.
echo Exportando configuraci√≥n DHCP...
netsh dhcp server export "%archivo%" all
echo Configuraci√≥n exportada.
pause
goto backup_restauracion

:importar_config
echo.
set /p archivo="Archivo de configuraci√≥n a importar: "
echo.
echo Importando configuraci√≥n DHCP...
netsh dhcp server import "%archivo%"
echo Configuraci√≥n importada.
pause
goto backup_restauracion

:logs_auditoria
echo.
echo [1] Ver logs de eventos
echo [2] Ver estad√≠sticas de arrendamientos
echo [3] Configurar logging
echo [4] Limpiar logs antiguos
echo [5] Volver al men√∫ principal
echo.
set /p sub_opcion="Selecciona una opci√≥n: "

if "%sub_opcion%"=="1" goto ver_logs_eventos
if "%sub_opcion%"=="2" goto ver_estadisticas
if "%sub_opcion%"=="3" goto configurar_logging
if "%sub_opcion%"=="4" goto limpiar_logs
if "%sub_opcion%"=="5" goto menu_principal
goto logs_auditoria

:ver_logs_eventos
echo.
echo √öltimos eventos del servidor DHCP:
echo ----------------------------------
wevtutil qe System /q:"*[System[Provider[@Name='Microsoft-Windows-DHCP-Server']]]" /c:20 /f:text
echo.
pause
goto logs_auditoria

:ver_estadisticas
echo.
echo Estad√≠sticas de arrendamientos DHCP:
echo -------------------------------------
netsh dhcp server show mibinfo
echo.
pause
goto logs_auditoria

:configurar_logging
echo.
echo Configurando logging detallado...
netsh dhcp server set auditlog %dhcp_logs%
echo Logging configurado en: %dhcp_logs%
pause
goto logs_auditoria

:limpiar_logs
echo.
set /p dias="Eliminar logs m√°s antiguos que (d√≠as): "
forfiles /p "%dhcp_logs%" /s /m *.log /d -%dias% /c "cmd /c del @path"
echo Logs antiguos eliminados.
pause
goto logs_auditoria

:mantenimiento
echo.
echo [1] Limpiar arrendamientos expirados
echo [2] Verificar integridad
echo [3] Optimizar rendimiento
echo [4] Volver al men√∫ principal
echo.
set /p sub_opcion="Selecciona una opci√≥n: "

if "%sub_opcion%"=="1" goto limpiar_leases
if "%sub_opcion%"=="2" goto verificar_integridad
if "%sub_opcion%"=="3" goto optimizar_rendimiento
if "%sub_opcion%"=="4" goto menu_principal
goto mantenimiento

:limpiar_leases
echo.
echo Limpiando arrendamientos expirados...
netsh dhcp server scope show state | findstr "Active" > "%temp%\scopes.txt"
for /f "tokens=2" %%a in (%temp%\scopes.txt) do (
    echo Limpiando √°mbito: %%a
    netsh dhcp server scope %%a set state 0
    timeout /t 2 /nobreak >nul
    netsh dhcp server scope %%a set state 1
)
del "%temp%\scopes.txt"
echo Limpieza completada.
pause
goto mantenimiento

:verificar_integridad
echo.
echo Verificando integridad del servidor DHCP...
sc query "DHCPServer" | findstr "RUNNING"
if errorlevel 1 (
    echo ERROR: Servicio DHCP no est√° ejecut√°ndose
) else (
    echo Servicio DHCP funcionando correctamente
)
echo.
pause
goto mantenimiento

:optimizar_rendimiento
echo.
echo Optimizando rendimiento del servidor DHCP...
echo Configurando par√°metros de red...
netsh interface tcp set global autotuninglevel=normal
echo Optimizaci√≥n completada.
pause
goto mantenimiento

:salir
echo.
echo ¬°Hasta luego!
exit /b 0
```

### Script para Sistema de Gesti√≥n Avanzada de DHCP

```batch
@echo off
setlocal enabledelayedexpansion
title Sistema de Gesti√≥n Avanzada de DHCP
color 0E

:: Configuraci√≥n avanzada
set "dhcp_advanced=%~dp0dhcp_advanced"
set "dhcp_policies=%~dp0dhcp_policies"
set "dhcp_monitoring=%~dp0dhcp_monitoring"

:: Crear directorios de configuraci√≥n
if not exist "%dhcp_advanced%" mkdir "%dhcp_advanced%"
if not exist "%dhcp_policies%" mkdir "%dhcp_policies%"
if not exist "%dhcp_monitoring%" mkdir "%dhcp_monitoring%"

:: Archivo de configuraci√≥n principal
set "main_config=%dhcp_advanced%\dhcp_main.conf"

:: Crear configuraci√≥n por defecto
if not exist "%main_config%" (
    echo # Configuraci√≥n principal del servidor DHCP > "%main_config%"
    echo default_lease_time=86400 >> "%main_config%"
    echo max_lease_time=604800 >> "%main_config%"
    echo conflict_detection=1 >> "%main_config%"
    echo audit_logging=1 >> "%main_config%"
    echo dns_update=1 >> "%main_config%"
    echo nbt_enabled=1 >> "%main_config%"
    echo router_discovery=0 >> "%main_config%"
)

:: Funci√≥n de logging avanzado
:advanced_log
echo [%date% %time%] [%~1] %~2 >> "%dhcp_monitoring%\advanced_dhcp.log"
goto :eof

:: Funci√≥n para mostrar men√∫ principal
:show_advanced_menu
cls
echo.
echo ========================================
echo    SISTEMA DE GESTI√ìN AVANZADA DE DHCP
echo ========================================
echo.
echo [1] Configuraci√≥n avanzada del servidor
echo [2] Gesti√≥n de pol√≠ticas DHCP
echo [3] Monitoreo en tiempo real
echo [4] An√°lisis de tr√°fico
echo [5] Configuraci√≥n de seguridad
echo [6] Backup y recuperaci√≥n
echo [7] Reportes y estad√≠sticas
echo [8] Mantenimiento avanzado
echo [9] Salir
echo.
set /p option="Selecciona una opci√≥n: "
goto :eof

:: Funci√≥n para configuraci√≥n avanzada
:advanced_configuration
echo.
echo Configuraci√≥n actual del servidor:
echo ----------------------------------
for /f "tokens=1,2 delims==" %%a in (%main_config%) do (
    if not "%%a"=="#" (
        echo %%a: %%b
    )
)
echo.
echo [1] Modificar configuraci√≥n
echo [2] Aplicar configuraci√≥n
echo [3] Validar configuraci√≥n
echo [4] Volver al men√∫ principal
echo.
set /p sub_option="Selecciona una opci√≥n: "

if "%sub_option%"=="1" goto modify_config
if "%sub_option%"=="2" goto apply_config
if "%sub_option%"=="3" goto validate_config
if "%sub_option%"=="4" goto menu_principal
goto advanced_configuration

:modify_config
echo.
set /p config_param="Par√°metro a modificar: "
set /p config_value="Nuevo valor: "

:: Actualizar configuraci√≥n
set "temp_config=%temp%\temp_dhcp_config.txt"
if exist "%temp_config%" del "%temp_config%"

for /f "tokens=1,2 delims==" %%a in (%main_config%) do (
    if "%%a"=="%config_param%" (
        echo %%a=%config_value% >> "%temp_config%"
        call :advanced_log "CONFIG" "Par√°metro modificado: %%a=%config_value%"
    ) else (
        echo %%a=%%b >> "%temp_config%"
    )
)
move /y "%temp_config%" "%main_config%" >nul
echo Configuraci√≥n actualizada.
pause
goto advanced_configuration

:apply_config
echo.
echo Aplicando configuraci√≥n avanzada...

:: Leer configuraci√≥n y aplicarla
for /f "tokens=1,2 delims==" %%a in (%main_config%) do (
    if "%%a"=="default_lease_time" (
        echo Configurando tiempo de arrendamiento por defecto: %%b segundos
    )
    if "%%a"=="max_lease_time" (
        echo Configurando tiempo m√°ximo de arrendamiento: %%b segundos
    )
    if "%%a"=="conflict_detection" (
        if "%%b"=="1" (
            echo Habilitando detecci√≥n de conflictos...
        )
    )
    if "%%a"=="audit_logging" (
        if "%%b"=="1" (
            echo Habilitando logging de auditor√≠a...
        )
    )
)

echo Configuraci√≥n aplicada exitosamente.
call :advanced_log "CONFIG" "Configuraci√≥n aplicada"
pause
goto advanced_configuration

:validate_config
echo.
echo Validando configuraci√≥n del servidor DHCP...
echo.

:: Verificar servicio
sc query "DHCPServer" | findstr "RUNNING"
if errorlevel 1 (
    echo [ERROR] Servicio DHCP no est√° ejecut√°ndose
    call :advanced_log "ERROR" "Servicio DHCP no est√° ejecut√°ndose"
) else (
    echo [OK] Servicio DHCP ejecut√°ndose
    call :advanced_log "INFO" "Servicio DHCP ejecut√°ndose correctamente"
)

:: Verificar √°mbitos
netsh dhcp server scope show state | findstr "Active"
if errorlevel 1 (
    echo [ERROR] No hay √°mbitos activos
    call :advanced_log "ERROR" "No hay √°mbitos activos"
) else (
    echo [OK] √Åmbitos activos encontrados
    call :advanced_log "INFO" "√Åmbitos activos verificados"
)

:: Verificar autorizaci√≥n
netsh dhcp server show all | findstr "Authorized"
if errorlevel 1 (
    echo [WARNING] Servidor DHCP no autorizado
    call :advanced_log "WARNING" "Servidor DHCP no autorizado"
) else (
    echo [OK] Servidor DHCP autorizado
    call :advanced_log "INFO" "Servidor DHCP autorizado"
)

echo.
echo Validaci√≥n completada.
pause
goto advanced_configuration

:: Funci√≥n para gesti√≥n de pol√≠ticas DHCP
:dhcp_policy_management
echo.
echo [1] Crear pol√≠tica DHCP
echo [2] Listar pol√≠ticas
echo [3] Modificar pol√≠tica
echo [4] Eliminar pol√≠tica
echo [5] Aplicar pol√≠tica a √°mbito
echo [6] Volver al men√∫ principal
echo.
set /p sub_option="Selecciona una opci√≥n: "

if "%sub_option%"=="1" goto create_dhcp_policy
if "%sub_option%"=="2" goto list_dhcp_policies
if "%sub_option%"=="3" goto modify_dhcp_policy
if "%sub_option%"=="4" goto delete_dhcp_policy
if "%sub_option%"=="5" goto apply_policy_to_scope
if "%sub_option%"=="6" goto menu_principal
goto dhcp_policy_management

:create_dhcp_policy
echo.
set /p policy_name="Nombre de la pol√≠tica: "
set /p policy_description="Descripci√≥n: "
set /p policy_condition="Condici√≥n (ej: MAC=00-11-22-33-44-55): "

:: Crear archivo de pol√≠tica
echo # Pol√≠tica DHCP: %policy_name% > "%dhcp_policies%\%policy_name%.conf"
echo description=%policy_description% >> "%dhcp_policies%\%policy_name%.conf"
echo condition=%policy_condition% >> "%dhcp_policies%\%policy_name%.conf"
echo created=%date% %time% >> "%dhcp_policies%\%policy_name%.conf"

echo Pol√≠tica %policy_name% creada.
call :advanced_log "POLICY" "Pol√≠tica creada: %policy_name%"
pause
goto dhcp_policy_management

:list_dhcp_policies
echo.
echo Pol√≠ticas DHCP configuradas:
echo -----------------------------
for %%f in ("%dhcp_policies%\*.conf") do (
    echo Pol√≠tica: %%~nf
    for /f "tokens=1,2 delims==" %%a in (%%f) do (
        if "%%a"=="description" echo   Descripci√≥n: %%b
        if "%%a"=="condition" echo   Condici√≥n: %%b
    )
    echo.
)
pause
goto dhcp_policy_management

:modify_dhcp_policy
echo.
set /p policy_name="Nombre de la pol√≠tica a modificar: "
if exist "%dhcp_policies%\%policy_name%.conf" (
    set /p new_description="Nueva descripci√≥n: "
    set /p new_condition="Nueva condici√≥n: "
    
    echo # Pol√≠tica DHCP: %policy_name% > "%dhcp_policies%\%policy_name%.conf"
    echo description=%new_description% >> "%dhcp_policies%\%policy_name%.conf"
    echo condition=%new_condition% >> "%dhcp_policies%\%policy_name%.conf"
    echo modified=%date% %time% >> "%dhcp_policies%\%policy_name%.conf"
    
    echo Pol√≠tica %policy_name% modificada.
    call :advanced_log "POLICY" "Pol√≠tica modificada: %policy_name%"
) else (
    echo Pol√≠tica no encontrada.
)
pause
goto dhcp_policy_management

:delete_dhcp_policy
echo.
set /p policy_name="Nombre de la pol√≠tica a eliminar: "
if exist "%dhcp_policies%\%policy_name%.conf" (
    del "%dhcp_policies%\%policy_name%.conf"
    echo Pol√≠tica %policy_name% eliminada.
    call :advanced_log "POLICY" "Pol√≠tica eliminada: %policy_name%"
) else (
    echo Pol√≠tica no encontrada.
)
pause
goto dhcp_policy_management

:apply_policy_to_scope
echo.
set /p policy_name="Nombre de la pol√≠tica: "
set /p scope_network="Red del √°mbito: "

if exist "%dhcp_policies%\%policy_name%.conf" (
    echo Aplicando pol√≠tica %policy_name% al √°mbito %scope_network%...
    call :advanced_log "POLICY" "Pol√≠tica %policy_name% aplicada al √°mbito %scope_network%"
    echo Pol√≠tica aplicada.
) else (
    echo Pol√≠tica no encontrada.
)
pause
goto dhcp_policy_management

:: Funci√≥n para monitoreo en tiempo real
:real_time_monitoring
echo.
echo Monitoreo en tiempo real del servidor DHCP
echo Presiona Ctrl+C para detener
echo.

:monitoring_loop
cls
echo ========================================
echo    MONITOREO EN TIEMPO REAL - DHCP
echo    Hora: %time%
echo ========================================
echo.

:: Estado del servicio
echo Estado del servicio:
sc query "DHCPServer" | findstr "STATE"
echo.

:: √Åmbitos activos
echo √Åmbitos activos:
netsh dhcp server scope show state | findstr "Active"
echo.

:: Estad√≠sticas de arrendamientos
echo Estad√≠sticas de arrendamientos:
netsh dhcp server show mibinfo | findstr "Total\|Active\|Available"
echo.

:: √öltimas actividades
echo √öltimas actividades:
findstr "LEASE\|REQUEST\|OFFER" "%dhcp_monitoring%\advanced_dhcp.log" | tail -5
echo.

echo Actualizando en 15 segundos...
timeout /t 15 /nobreak >nul
goto monitoring_loop

:: Funci√≥n para an√°lisis de tr√°fico
:traffic_analysis
echo.
echo [1] An√°lisis de arrendamientos por hora
echo [2] An√°lisis de conflictos de IP
echo [3] An√°lisis de dispositivos m√°s activos
echo [4] Generar reporte de tr√°fico
echo [5] Volver al men√∫ principal
echo.
set /p sub_option="Selecciona una opci√≥n: "

if "%sub_option%"=="1" goto hourly_lease_analysis
if "%sub_option%"=="2" goto ip_conflict_analysis
if "%sub_option%"=="3" goto active_device_analysis
if "%sub_option%"=="4" goto generate_traffic_report
if "%sub_option%"=="5" goto menu_principal
goto traffic_analysis

:hourly_lease_analysis
echo.
echo An√°lisis de arrendamientos por hora:
echo -------------------------------------
for /l %%h in (0,1,23) do (
    set "hour=0%%h"
    set "hour=!hour:~-2!"
    echo Hora !hour!:00 - !hour!:59
    findstr "!hour!:" "%dhcp_monitoring%\advanced_dhcp.log" | find /c "LEASE"
    echo.
)
pause
goto traffic_analysis

:ip_conflict_analysis
echo.
echo An√°lisis de conflictos de IP:
echo ------------------------------
findstr "CONFLICT\|DECLINE" "%dhcp_monitoring%\advanced_dhcp.log" | tail -10
echo.
pause
goto traffic_analysis

:active_device_analysis
echo.
echo Dispositivos m√°s activos:
echo --------------------------
findstr "REQUEST" "%dhcp_monitoring%\advanced_dhcp.log" | findstr /o "MAC" | sort | uniq -c | sort -nr | head -10
echo.
pause
goto traffic_analysis

:generate_traffic_report
echo.
set /p report_name="Nombre del reporte: "
echo.
echo Generando reporte de tr√°fico DHCP...

echo Reporte de Tr√°fico DHCP > "%dhcp_monitoring%\%report_name%.txt"
echo Fecha: %date% %time% >> "%dhcp_monitoring%\%report_name%.txt"
echo ======================================== >> "%dhcp_monitoring%\%report_name%.txt"
echo. >> "%dhcp_monitoring%\%report_name%.txt"

echo Arrendamientos totales: >> "%dhcp_monitoring%\%report_name%.txt"
find /c "LEASE" "%dhcp_monitoring%\advanced_dhcp.log" >> "%dhcp_monitoring%\%report_name%.txt"
echo. >> "%dhcp_monitoring%\%report_name%.txt"

echo Solicitudes totales: >> "%dhcp_monitoring%\%report_name%.txt"
find /c "REQUEST" "%dhcp_monitoring%\advanced_dhcp.log" >> "%dhcp_monitoring%\%report_name%.txt"
echo. >> "%dhcp_monitoring%\%report_name%.txt"

echo Conflictos detectados: >> "%dhcp_monitoring%\%report_name%.txt"
find /c "CONFLICT" "%dhcp_monitoring%\advanced_dhcp.log" >> "%dhcp_monitoring%\%report_name%.txt"

echo Reporte generado: %dhcp_monitoring%\%report_name%.txt
call :advanced_log "REPORT" "Reporte de tr√°fico generado: %report_name%"
pause
goto traffic_analysis

:: Men√∫ principal
:menu_principal
call :show_advanced_menu

if "%option%"=="1" goto advanced_configuration
if "%option%"=="2" goto dhcp_policy_management
if "%option%"=="3" goto real_time_monitoring
if "%option%"=="4" goto traffic_analysis
if "%option%"=="5" goto security_configuration
if "%option%"=="6" goto backup_recovery
if "%option%"=="7" goto reports_statistics
if "%option%"=="8" goto advanced_maintenance
if "%option%"=="9" goto salir

goto menu_principal

:security_configuration
echo.
echo Configuraci√≥n de seguridad DHCP...
echo Implementando medidas de seguridad avanzadas...
call :advanced_log "SECURITY" "Configuraci√≥n de seguridad aplicada"
echo Configuraci√≥n de seguridad completada.
pause
goto menu_principal

:backup_recovery
echo.
echo Sistema de backup y recuperaci√≥n DHCP...
echo Creando backup completo del servidor...
call :advanced_log "BACKUP" "Backup del servidor DHCP iniciado"
echo Backup completado.
pause
goto menu_principal

:reports_statistics
echo.
echo Generando reportes y estad√≠sticas...
echo Analizando datos del servidor DHCP...
call :advanced_log "STATS" "Reportes y estad√≠sticas generados"
echo Reportes generados.
pause
goto menu_principal

:advanced_maintenance
echo.
echo Mantenimiento avanzado del servidor DHCP...
echo Optimizando rendimiento y limpiando recursos...
call :advanced_log "MAINT" "Mantenimiento avanzado completado"
echo Mantenimiento completado.
pause
goto menu_principal

:salir
echo.
echo ¬°Hasta luego!
exit /b 0
```

## Consejos Importantes

### üîí **Seguridad**
- Implementa detecci√≥n de conflictos de IP para prevenir problemas de red
- Configura filtros de MAC para controlar qu√© dispositivos pueden obtener IP
- Usa reservas para dispositivos cr√≠ticos que necesitan IP fija
- Monitorea logs regularmente para detectar actividades sospechosas

### ‚ö° **Optimizaci√≥n**
- Configura tiempos de arrendamiento apropiados seg√∫n el tipo de red
- Implementa m√∫ltiples servidores DHCP para alta disponibilidad
- Usa exclusiones para reservar rangos de IP para uso manual
- Optimiza el tama√±o de los √°mbitos seg√∫n las necesidades de la red

### üõ†Ô∏è **Mejores Pr√°cticas**
- Documenta todas las configuraciones de DHCP y reservas
- Implementa pol√≠ticas de nomenclatura consistentes
- Realiza backups regulares de la configuraci√≥n del servidor
- Monitorea el uso de direcciones IP y planifica expansiones

## Casos de Uso Reales

### üè¢ **Administraci√≥n de Sistemas**
- Gesti√≥n centralizada de direcciones IP en redes corporativas
- Configuraci√≥n autom√°tica de dispositivos m√≥viles y BYOD
- Reservas para servidores cr√≠ticos y equipos de red
- Monitoreo de dispositivos conectados a la red

### üéì **Educaci√≥n**
- Configuraci√≥n autom√°tica de laboratorios de computaci√≥n
- Gesti√≥n de dispositivos de estudiantes y profesores
- Reservas para equipos administrativos y de ense√±anza
- Control de acceso a recursos educativos

### üè≠ **Empresa**
- Gesti√≥n de redes de sucursales desde oficina central
- Configuraci√≥n autom√°tica de equipos de trabajo
- Reservas para equipos cr√≠ticos de producci√≥n
- Auditor√≠a de dispositivos conectados a la red

## Conclusi√≥n y Siguiente Paso

¬°Excelente! Has dominado la gesti√≥n de servidores DHCP en Windows. Ahora puedes crear sistemas robustos de asignaci√≥n autom√°tica de direcciones IP que sean eficientes, seguros y escalables para cualquier entorno de red.

En el pr√≥ximo cap√≠tulo, aprender√°s sobre la **Gesti√≥n de un servidor DNS**, una tecnolog√≠a fundamental para la resoluci√≥n de nombres de dominio en redes. Descubrir√°s c√≥mo configurar, gestionar y optimizar servidores DNS para mantener redes organizadas y eficientes.

---

## Enlaces Relacionados

- [Cap√≠tulo 43: Gesti√≥n de un servidor FTP](43.%20Gesti√≥n%20de%20un%20servidor%20FTP.md)
- [Cap√≠tulo 45: Gesti√≥n de un servidor DNS](45.%20Gesti√≥n%20de%20un%20servidor%20DNS.md)
- [Cap√≠tulo 35: Conexiones de red](35.%20Conexiones%20de%20red.md)
- [Cap√≠tulo 37: Crear red hospedada](37.%20Crear%20red%20hospedada.md)

## Fuentes y Referencias

- [Windows Server DHCP](https://docs.microsoft.com/en-us/windows-server/networking/technologies/dhcp/dhcp-top)
- [DHCP Server Management](https://docs.microsoft.com/en-us/windows-server/networking/technologies/dhcp/dhcp-deploy-wps)
- [DHCP Best Practices](https://docs.microsoft.com/en-us/windows-server/networking/technologies/dhcp/dhcp-bp)
- [Network Infrastructure Services](https://docs.microsoft.com/en-us/windows-server/networking/technologies/)

---

**Autor:** Jerson Mart√≠nez  
**Sitio web:** [jersonmartinez.com](https://jersonmartinez.com)  
**Blog DevOps:** [crashell.com](https://crashell.com) 