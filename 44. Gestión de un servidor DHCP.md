# 44. Gesti√≥n de un servidor DHCP üåêüîß

> *"En el mundo de las redes, el DHCP es el director de tr√°fico invisible que asigna direcciones IP autom√°ticamente, manteniendo el orden en el caos de dispositivos conectados."*

## Introducci√≥n

¬øTe imaginas tener que configurar manualmente la direcci√≥n IP de cada dispositivo en una red de 1000 equipos? ¬øO qu√© pasar√≠a si dos dispositivos tuvieran la misma direcci√≥n IP? El **Protocolo de Configuraci√≥n Din√°mica de Host (DHCP)** es la soluci√≥n elegante que hace que las redes funcionen de manera fluida y autom√°tica.

En este cap√≠tulo, aprender√°s a configurar, gestionar y optimizar un servidor DHCP en Windows. Desde la instalaci√≥n b√°sica hasta configuraciones avanzadas de reservas y pol√≠ticas, descubrir√°s c√≥mo crear un sistema de asignaci√≥n de direcciones IP que sea robusto, eficiente y escalable.

## Conceptos Clave

### üåê **DHCP (Dynamic Host Configuration Protocol)**
Protocolo que automatiza la asignaci√≥n de direcciones IP y configuraciones de red a dispositivos cliente, eliminando la necesidad de configuraci√≥n manual.

### üìã **Scope (√Åmbito)**
Rango de direcciones IP que el servidor DHCP puede asignar a los clientes, incluyendo configuraciones como m√°scara de subred y gateway.

### üîí **Reservation (Reserva)**
Asignaci√≥n permanente de una direcci√≥n IP espec√≠fica a un dispositivo basado en su direcci√≥n MAC, garantizando consistencia.

### ‚è∞ **Lease (Arrendamiento)**
Per√≠odo de tiempo durante el cual un cliente puede usar una direcci√≥n IP asignada antes de renovarla o liberarla.

## Comandos Principales

### `NETSH DHCP` - Gesti√≥n de servidor DHCP
Comando principal para gestionar el servidor DHCP desde la l√≠nea de comandos.

**Sintaxis b√°sica:**
```batch
netsh dhcp [opciones]
```

**Opciones principales:**
- `server` - Gestionar servidor DHCP espec√≠fico
- `scope` - Gestionar √°mbitos DHCP
- `reservation` - Gestionar reservas de IP
- `option` - Configurar opciones DHCP

### `NETSH DHCP SERVER` - Configuraci√≥n del servidor
Comando para configurar par√°metros del servidor DHCP.

**Sintaxis:**
```batch
netsh dhcp server [opciones]
```

**Opciones principales:**
- `add securitygroups` - Autorizar servidor DHCP
- `show all` - Mostrar configuraci√≥n completa
- `set auditlog` - Configurar logging de auditor√≠a
- `export` - Exportar configuraci√≥n
- `import` - Importar configuraci√≥n

### `NETSH DHCP SERVER SCOPE` - Gesti√≥n de √°mbitos
Comando para crear, configurar y gestionar √°mbitos DHCP.

**Sintaxis:**
```batch
netsh dhcp server scope [red] [comando] [par√°metros]
```

**Comandos principales:**
- `add` - Crear nuevo √°mbito
- `set state` - Activar/desactivar √°mbito
- `set lease` - Configurar tiempo de arrendamiento
- `add excluderange` - Agregar rango de exclusi√≥n
- `delete` - Eliminar √°mbito

### `NETSH DHCP SERVER RESERVATION` - Gesti√≥n de reservas
Comando para gestionar reservas de direcciones IP.

**Sintaxis:**
```batch
netsh dhcp server scope [red] add reservedip [ip] [mac] [nombre]
```

**Opciones principales:**
- `add reservedip` - Crear nueva reserva
- `delete reservedip` - Eliminar reserva
- `set reservedoptionvalue` - Configurar opciones de reserva

### `NETSH DHCP SERVER SCOPE OPTION` - Configuraci√≥n de opciones
Comando para configurar opciones DHCP como gateway, DNS, etc.

**Sintaxis:**
```batch
netsh dhcp server scope [red] set optionvalue [c√≥digo] [tipo] [valor]
```

**C√≥digos de opci√≥n principales:**
- `3` - Gateway (Router)
- `6` - Servidores DNS
- `15` - Nombre de dominio
- `44` - Servidores WINS
- `51` - Tiempo de arrendamiento

### `DISM` - Instalaci√≥n del rol DHCP
Comando para instalar el rol de servidor DHCP en Windows Server.

**Sintaxis:**
```batch
dism /online /enable-feature /featurename:DHCPServer /all
```

### `SC` - Gesti√≥n del servicio DHCP
Comando para gestionar el servicio DHCP del sistema.

**Sintaxis:**
```batch
sc [start|stop|query] "DHCPServer"
```

### `NET START/STOP` - Control del servicio DHCP
Comando para iniciar o detener el servicio DHCP.

**Sintaxis:**
```batch
net start "DHCP Server"
net stop "DHCP Server"
```

### `WEVTUTIL` - Consulta de logs de eventos
Comando para consultar logs de eventos del servidor DHCP.

**Sintaxis:**
```batch
wevtutil qe System /q:"*[System[Provider[@Name='Microsoft-Windows-DHCP-Server']]]" /c:20 /f:text
```

## Ejemplos Pr√°cticos

### 1. **Instalar el rol de servidor DHCP**
```batch
dism /online /enable-feature /featurename:DHCPServer /all
```
**Prop√≥sito:** Instalar el servicio DHCP nativo de Windows Server. Es el primer paso para crear un servidor de asignaci√≥n autom√°tica de direcciones IP.

### 2. **Iniciar el servicio DHCP**
```batch
net start "DHCP Server"
```
**Prop√≥sito:** Activar el servicio DHCP despu√©s de la instalaci√≥n. Esencial para que el servidor comience a asignar direcciones IP a los clientes.

### 3. **Crear un √°mbito DHCP b√°sico**
```batch
netsh dhcp server scope 192.168.1.0 add name="Red Principal" start=192.168.1.100 end=192.168.1.200
```
**Prop√≥sito:** Definir un rango de direcciones IP que el servidor puede asignar. Fundamental para organizar la red y evitar conflictos.

### 4. **Configurar opciones del √°mbito**
```batch
netsh dhcp server scope 192.168.1.0 set optionvalue 3 IPADDRESS 192.168.1.1
```
**Prop√≥sito:** Establecer el gateway predeterminado para todos los clientes del √°mbito. Esencial para la conectividad de red.

### 5. **Crear una reserva de direcci√≥n IP**
```batch
netsh dhcp server scope 192.168.1.0 add reservedip 192.168.1.50 00-11-22-33-44-55 "Servidor Web"
```
**Prop√≥sito:** Asignar una direcci√≥n IP fija a un dispositivo espec√≠fico basado en su MAC. Ideal para servidores y dispositivos cr√≠ticos.

### 6. **Configurar servidores DNS**
```batch
netsh dhcp server scope 192.168.1.0 set optionvalue 6 IPADDRESS 8.8.8.8 8.8.4.4
```
**Prop√≥sito:** Proporcionar direcciones de servidores DNS a los clientes DHCP. Necesario para la resoluci√≥n de nombres de dominio.

### 7. **Verificar estado del servidor DHCP**
```batch
netsh dhcp server show all
```
**Prop√≥sito:** Comprobar la configuraci√≥n completa del servidor DHCP. √ötil para diagn√≥stico y auditor√≠a de configuraciones.

### 8. **Mostrar √°mbitos activos**
```batch
netsh dhcp server scope show state
```
**Prop√≥sito:** Ver todos los √°mbitos configurados y su estado actual. Esencial para administraci√≥n y monitoreo.

### 9. **Configurar tiempo de arrendamiento**
```batch
netsh dhcp server scope 192.168.1.0 set lease 86400
```
**Prop√≥sito:** Establecer el tiempo de arrendamiento en segundos (24 horas en este caso). Afecta la frecuencia de renovaciones.

### 10. **Excluir rangos de direcciones**
```batch
netsh dhcp server scope 192.168.1.0 add excluderange 192.168.1.1 192.168.1.10
```
**Prop√≥sito:** Reservar direcciones IP para uso manual o dispositivos est√°ticos. Previene conflictos con equipos con IP fija.